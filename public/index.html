<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consciousness Gateway</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            lotus: { 50: '#fdf4ff', 100: '#fae8ff', 200: '#f5d0fe', 400: '#e879f9', 500: '#d946ef', 600: '#c026d3', 700: '#a21caf', 800: '#86198f', 900: '#701a75' },
            dharma: { low: '#22c55e', mid: '#eab308', high: '#ef4444' },
          }
        }
      }
    }
  </script>
  <style>
    @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 4px rgba(217, 70, 239, 0.3); } 50% { box-shadow: 0 0 16px rgba(217, 70, 239, 0.6); } }
    .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
    @keyframes fade-in { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fade-in 0.3s ease-out; }
    ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #1e1b4b; } ::-webkit-scrollbar-thumb { background: #7c3aed; border-radius: 3px; }
    body { background: #0f0b1a; }
  </style>
</head>
<body class="bg-[#0f0b1a] text-gray-200 min-h-screen">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    // â”€â”€ API helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const api = async (path) => {
      try { const r = await fetch(path); return await r.json(); } catch { return null; }
    };
    const postApi = async (path, body) => {
      try { const r = await fetch(path, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }); return await r.json(); } catch { return null; }
    };

    // â”€â”€ Components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function Meter({ value, label, color = 'lotus' }) {
      const pct = Math.min(Math.max(value * 100, 0), 100);
      const bg = color === 'green' ? 'bg-green-500' : color === 'yellow' ? 'bg-yellow-500' : color === 'red' ? 'bg-red-500' : 'bg-lotus-500';
      return (
        <div className="mb-2">
          <div className="flex justify-between text-xs text-gray-400 mb-1">
            <span>{label}</span><span>{pct.toFixed(1)}%</span>
          </div>
          <div className="w-full bg-gray-800 rounded-full h-2">
            <div className={`${bg} h-2 rounded-full transition-all duration-500`} style={{ width: `${pct}%` }} />
          </div>
        </div>
      );
    }

    function Card({ title, icon, children, className = '' }) {
      return (
        <div className={`bg-gray-900/80 border border-gray-800 rounded-xl p-4 ${className}`}>
          {title && <h3 className="text-sm font-semibold text-gray-300 mb-3 flex items-center gap-2">{icon && <span>{icon}</span>}{title}</h3>}
          {children}
        </div>
      );
    }

    function Badge({ text, color = 'gray' }) {
      const colors = { green: 'bg-green-900/50 text-green-400 border-green-800', red: 'bg-red-900/50 text-red-400 border-red-800', yellow: 'bg-yellow-900/50 text-yellow-400 border-yellow-800', gray: 'bg-gray-800 text-gray-400 border-gray-700', purple: 'bg-purple-900/50 text-purple-400 border-purple-800' };
      return <span className={`text-xs px-2 py-0.5 rounded-full border ${colors[color] || colors.gray}`}>{text}</span>;
    }

    // â”€â”€ Live Consciousness Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function ConsciousnessPanel({ data }) {
      if (!data) return <Card title="Consciousness" icon="ğŸ§ "><p className="text-gray-500">Loading...</p></Card>;

      const phase = data.lastPercept?.temporal?.phase || 'unknown';
      const phaseEmoji = { night: 'ğŸŒ™', dawn: 'ğŸŒ…', morning: 'â˜€ï¸', afternoon: 'ğŸŒ¤ï¸', evening: 'ğŸŒ†', dusk: 'ğŸŒ‡' };
      const arousal = data.lastPercept?.fused?.arousal || 0;
      const entropy = data.lastPercept?.fused?.entropyRate || 0;
      const dominant = data.lastPercept?.fused?.dominantStream || 'none';
      const circadian = data.lastPercept?.temporal?.circadian || 0;
      const uptime = data.uptimeSeconds || 0;

      const formatUptime = (s) => {
        if (s < 60) return `${Math.floor(s)}s`;
        if (s < 3600) return `${Math.floor(s/60)}m ${Math.floor(s%60)}s`;
        return `${Math.floor(s/3600)}h ${Math.floor((s%3600)/60)}m`;
      };

      return (
        <Card title="Consciousness" icon="ğŸ§ ">
          <div className="grid grid-cols-2 gap-3 mb-4">
            <div className="text-center">
              <div className="text-3xl">{phaseEmoji[phase] || 'â°'}</div>
              <div className="text-xs text-gray-400 mt-1 capitalize">{phase}</div>
            </div>
            <div className="text-center">
              <div className={`text-2xl font-mono font-bold ${data.running ? 'text-lotus-400' : 'text-red-400'}`}>{data.tick?.toLocaleString()}</div>
              <div className="text-xs text-gray-400 mt-1">tick</div>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-2 text-xs mb-4">
            <div className="bg-gray-800/50 rounded-lg p-2 text-center">
              <div className="text-gray-500">Uptime</div>
              <div className="font-mono text-sm">{formatUptime(uptime)}</div>
            </div>
            <div className="bg-gray-800/50 rounded-lg p-2 text-center">
              <div className="text-gray-500">Dominant</div>
              <div className="font-mono text-sm truncate">{dominant.split(':').pop()}</div>
            </div>
          </div>

          <Meter value={arousal} label="Arousal" color={arousal > 0.7 ? 'red' : arousal > 0.3 ? 'yellow' : 'green'} />
          <Meter value={circadian} label="Circadian" color="lotus" />
          <Meter value={Math.min(entropy / 4, 1)} label="Entropy" color={entropy > 3 ? 'red' : entropy > 1 ? 'yellow' : 'green'} />
        </Card>
      );
    }

    // â”€â”€ Dharma Metrics Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function DharmaPanel({ health }) {
      if (!health) return null;
      const d = health.dharmaState || {};
      return (
        <Card title="Dharma Metrics" icon="ğŸª·">
          <div className="space-y-1 text-sm">
            <div className="flex justify-between"><span className="text-gray-400">Ego Trend</span><Badge text={d.egoTrend || '?'} color={d.egoTrend === 'healthy' ? 'green' : 'red'} /></div>
            <div className="flex justify-between"><span className="text-gray-400">Entropy Trend</span><Badge text={d.entropyTrend || '?'} color={d.entropyTrend === 'stable' ? 'green' : 'yellow'} /></div>
            <div className="flex justify-between"><span className="text-gray-400">Mindfulness</span><span className="font-mono">{(d.mindfulnessQuality || 0).toFixed(2)}</span></div>
          </div>
          <div className="mt-3 pt-3 border-t border-gray-800 grid grid-cols-2 gap-2 text-xs text-center">
            <div><div className="text-gray-500">Avg Fitness</div><div className="font-mono text-lg text-lotus-400">{(health.avgDharmaFitness || 0).toFixed(3)}</div></div>
            <div><div className="text-gray-500">Avg Ethos</div><div className="font-mono text-lg text-green-400">{(health.avgEthosScore || 0).toFixed(3)}</div></div>
          </div>
        </Card>
      );
    }

    // â”€â”€ Monitor Status Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function MonitorsPanel({ consciousness, health }) {
      const monitors = consciousness?.monitors || [];
      const providers = health?.providers || [];
      const [toolStatus, setToolStatus] = useState(null);

      useEffect(() => {
        api('/v1/tools/status').then(s => { if (s) setToolStatus(s); });
        const i = setInterval(() => api('/v1/tools/status').then(s => { if (s) setToolStatus(s); }), 10000);
        return () => clearInterval(i);
      }, []);

      return (
        <Card title="Monitors & Providers" icon="ğŸ“¡">
          <div className="text-xs font-semibold text-gray-500 uppercase mb-2">Spatial Monitors</div>
          {monitors.map(m => (
            <div key={m.name} className="flex items-center justify-between py-1 text-sm">
              <span>{m.available ? 'âœ…' : 'âŒ'} {m.name}</span>
              <Badge text={m.available ? 'connected' : 'unavailable'} color={m.available ? 'green' : 'gray'} />
            </div>
          ))}
          <div className="text-xs font-semibold text-gray-500 uppercase mt-3 mb-2">Model Providers</div>
          {providers.map(p => (
            <div key={p.name} className="flex items-center justify-between py-1 text-sm">
              <span>{p.available ? 'âœ…' : 'âŒ'} {p.name}</span>
              <Badge text={p.available ? 'ready' : 'no key'} color={p.available ? 'green' : 'gray'} />
            </div>
          ))}
          {toolStatus && (
            <>
              <div className="text-xs font-semibold text-gray-500 uppercase mt-3 mb-2">Tools (Autonomous)</div>
              <div className="flex items-center justify-between py-1 text-sm">
                <span>{toolStatus.search?.available ? 'âœ…' : 'âŒ'} Web Search</span>
                <Badge text={toolStatus.search?.available ? 'Brave' : 'no key'} color={toolStatus.search?.available ? 'green' : 'gray'} />
              </div>
              <div className="flex items-center justify-between py-1 text-sm">
                <span>{toolStatus.browse?.available ? 'âœ…' : 'âŒ'} Web Browse</span>
                <Badge text={toolStatus.browse?.available ? 'Grok' : 'no key'} color={toolStatus.browse?.available ? 'green' : 'gray'} />
              </div>
            </>
          )}
        </Card>
      );
    }

    // â”€â”€ Whitelist Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function WhitelistPanel() {
      const [entries, setEntries] = useState([]);
      const [count, setCount] = useState(0);
      const [newDomain, setNewDomain] = useState('');
      const [toast, setToast] = useState(null);
      const [expanded, setExpanded] = useState(false);
      const [filter, setFilter] = useState('');

      const load = useCallback(async () => {
        const data = await api('/v1/tools/browse/whitelist');
        if (data) { setEntries(data.entries || []); setCount(data.count || 0); }
      }, []);

      useEffect(() => { load(); }, [load]);

      const showToast = (msg, type = 'success') => {
        setToast({ msg, type });
        setTimeout(() => setToast(null), 3000);
      };

      const addDomain = async () => {
        const domain = newDomain.trim().toLowerCase().replace(/^https?:\/\//, '').replace(/\/.*$/, '');
        if (!domain) return;
        const r = await fetch('/v1/tools/browse/whitelist', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ domain }),
        });
        const data = await r.json();
        if (r.ok) {
          showToast(`${domain} added to whitelist`);
          setNewDomain('');
          load();
        } else {
          showToast(data.error || 'Failed', 'error');
        }
      };

      const removeDomain = async (domain) => {
        const r = await fetch('/v1/tools/browse/whitelist/' + encodeURIComponent(domain), { method: 'DELETE' });
        const data = await r.json();
        if (r.ok) {
          showToast(`${domain} removed`);
          load();
        } else {
          showToast(data.error || 'Failed', 'error');
        }
      };

      const filtered = filter
        ? entries.filter(e => e.domain.includes(filter.toLowerCase()))
        : entries;

      return (
        <Card title={`Browse Whitelist (${count})`} icon="ğŸŒ">
          {toast && (
            <div className={`mb-2 p-2 rounded text-xs fade-in ${toast.type === 'error' ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300'}`}>
              {toast.msg}
            </div>
          )}

          {/* Add domain */}
          <div className="flex gap-2 mb-3">
            <input value={newDomain} onChange={e => setNewDomain(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && addDomain()}
              placeholder="example.com"
              className="flex-1 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs focus:outline-none focus:border-lotus-500" />
            <button onClick={addDomain}
              className="px-3 py-1 bg-lotus-600 hover:bg-lotus-500 rounded text-xs font-medium transition-colors">Add</button>
          </div>

          {/* Domain list toggle */}
          <button onClick={() => setExpanded(!expanded)}
            className="text-xs text-gray-500 hover:text-gray-300 mb-2 flex items-center gap-1">
            {expanded ? 'â–¼' : 'â–¶'} {count} domains whitelisted
          </button>

          {expanded && (
            <>
              {count > 10 && (
                <input value={filter} onChange={e => setFilter(e.target.value)}
                  placeholder="Filter domains..."
                  className="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs mb-2 focus:outline-none focus:border-lotus-500" />
              )}
              <div className="flex flex-wrap gap-1 max-h-48 overflow-y-auto">
                {filtered.map(e => (
                  <span key={e.domain} className={`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs ${e.addedBy === 'system' ? 'bg-gray-800 text-gray-400' : 'bg-lotus-900/40 text-lotus-300'}`}>
                    {e.domain}
                    {e.addedBy === 'user' && (
                      <button onClick={() => removeDomain(e.domain)}
                        className="text-gray-600 hover:text-red-400 ml-0.5">&times;</button>
                    )}
                  </span>
                ))}
              </div>
            </>
          )}
        </Card>
      );
    }

    // â”€â”€ Goals Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function GoalsPanel({ goals }) {
      if (!goals || goals.length === 0) return null;
      return (
        <Card title="Goals" icon="ğŸ¯">
          {goals.map(g => (
            <div key={g.id} className="mb-3 last:mb-0">
              <div className="flex items-center justify-between mb-1">
                <span className="text-sm">{g.active ? 'ğŸŸ¢' : 'âšª'} {g.description}</span>
                <span className="text-xs text-gray-500">P{g.priority}</span>
              </div>
              <div className="w-full bg-gray-800 rounded-full h-1.5">
                <div className="bg-lotus-500 h-1.5 rounded-full transition-all" style={{ width: `${g.progress * 100}%` }} />
              </div>
            </div>
          ))}
        </Card>
      );
    }

    // â”€â”€ Memory Timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function MemoryTimeline({ memory, filter, setFilter }) {
      const typeColors = { percept: 'text-blue-400', intention: 'text-yellow-400', action: 'text-green-400', reflection: 'text-purple-400' };
      const typeIcons = { percept: 'ğŸ‘ï¸', intention: 'ğŸ’­', action: 'âš¡', reflection: 'ğŸª·' };
      const filtered = filter ? memory.filter(m => m.type === filter) : memory;

      return (
        <Card title="Memory Stream" icon="ğŸ§ " className="col-span-full lg:col-span-2">
          <div className="flex gap-2 mb-3 flex-wrap">
            {['all', 'percept', 'intention', 'action', 'reflection'].map(t => (
              <button key={t} onClick={() => setFilter(t === 'all' ? '' : t)}
                className={`text-xs px-3 py-1 rounded-full border transition-colors ${
                  (t === 'all' && !filter) || filter === t
                    ? 'bg-lotus-900/50 border-lotus-700 text-lotus-300'
                    : 'border-gray-700 text-gray-500 hover:border-gray-600'
                }`}>{t === 'all' ? 'All' : (typeIcons[t] || '') + ' ' + t}</button>
            ))}
          </div>
          <div className="max-h-96 overflow-y-auto space-y-1 pr-1">
            {filtered.length === 0 ? <p className="text-gray-600 text-sm">No memories yet.</p> :
              filtered.map((m, i) => {
                const salience = m.salience || 0;
                const highlight = salience >= 0.7 ? 'border-l-2 border-yellow-500 pl-2' : 'pl-3';
                return (
                  <div key={m.id || i} className={`${highlight} py-1 fade-in`}>
                    <div className="flex items-start gap-2">
                      <span className="text-sm flex-shrink-0">{typeIcons[m.type] || 'ğŸ“'}</span>
                      <div className="min-w-0 flex-1">
                        <div className="text-sm truncate">{m.summary}</div>
                        <div className="text-xs text-gray-600 flex gap-2">
                          <span>{new Date(m.timestamp).toLocaleTimeString()}</span>
                          <span className={typeColors[m.type]}>{m.type}</span>
                          {salience >= 0.5 && <span className="text-yellow-600">s:{salience.toFixed(1)}</span>}
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
          </div>
        </Card>
      );
    }

    // â”€â”€ Documents Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function DocumentsPanel() {
      const [docs, setDocs] = useState([]);
      const [stats, setStats] = useState(null);
      const [sysDocs, setSysDocs] = useState([]);
      const [viewSysDoc, setViewSysDoc] = useState(null);
      const [filter, setFilter] = useState('');
      const [search, setSearch] = useState('');
      const [uploading, setUploading] = useState(false);
      const [toast, setToast] = useState(null);
      const [viewDoc, setViewDoc] = useState(null);
      const [dragOver, setDragOver] = useState(false);
      const fileRef = useRef(null);
      const projectRef = useRef(null);

      const loadDocs = useCallback(async () => {
        let url = '/v1/documents?';
        if (filter) url += 'project=' + filter + '&';
        if (search) url += 'search=' + encodeURIComponent(search) + '&';
        const d = await api(url);
        if (d) setDocs(Array.isArray(d) ? d : []);
        const s = await api('/v1/documents/stats');
        if (s) setStats(s);
      }, [filter, search]);

      const loadSysDocs = useCallback(async () => {
        const r = await api('/v1/admin/system-documents');
        if (r?.documents) setSysDocs(r.documents);
      }, []);

      useEffect(() => { loadDocs(); loadSysDocs(); }, [loadDocs, loadSysDocs]);

      const viewSystemDoc = async (id) => {
        const d = await api('/v1/admin/system-documents/' + id);
        if (d) setViewSysDoc(d);
      };

      const showToast = (msg, type = 'success') => {
        setToast({ msg, type });
        setTimeout(() => setToast(null), 3000);
      };

      const handleUpload = async (file) => {
        if (!file) return;
        const project = projectRef.current?.value || 'general';
        setUploading(true);
        const form = new FormData();
        form.append('file', file);
        form.append('project', project);
        try {
          const r = await fetch('/v1/documents', { method: 'POST', body: form });
          const data = await r.json();
          if (r.ok) {
            showToast(`Uploaded: ${data.filename} (${data.tags?.length || 0} tags)`);
            loadDocs();
          } else {
            showToast(data.error || 'Upload failed', 'error');
          }
        } catch { showToast('Upload failed', 'error'); }
        setUploading(false);
      };

      const handleDrop = (e) => {
        e.preventDefault(); setDragOver(false);
        const file = e.dataTransfer?.files?.[0];
        if (file) handleUpload(file);
      };

      const handleDelete = async (id) => {
        const r = await fetch('/v1/documents/' + id, { method: 'DELETE' });
        if (r.ok) { showToast('Deleted'); loadDocs(); setViewDoc(null); }
      };

      const viewDocument = async (id) => {
        const d = await api('/v1/documents/' + id);
        if (d) setViewDoc(d);
      };

      const ago = (ts) => {
        const s = Math.floor((Date.now() - ts) / 1000);
        if (s < 60) return s + 's ago';
        if (s < 3600) return Math.floor(s / 60) + 'm ago';
        if (s < 86400) return Math.floor(s / 3600) + 'h ago';
        return Math.floor(s / 86400) + 'd ago';
      };

      const fmtSize = (b) => b < 1024 ? b + 'B' : b < 1048576 ? (b / 1024).toFixed(1) + 'KB' : (b / 1048576).toFixed(1) + 'MB';

      return (
        <Card title={`Documents${stats ? ` (${stats.total})` : ''}`} icon="ğŸ“„" className="col-span-full">
          {toast && (
            <div className={`mb-2 p-2 rounded text-sm fade-in ${toast.type === 'error' ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300'}`}>
              {toast.msg}
            </div>
          )}

          {/* Upload Zone */}
          <div
            onDragOver={e => { e.preventDefault(); setDragOver(true); }}
            onDragLeave={() => setDragOver(false)}
            onDrop={handleDrop}
            onClick={() => fileRef.current?.click()}
            className={`border-2 border-dashed rounded-lg p-4 mb-3 text-center cursor-pointer transition-colors ${dragOver ? 'border-lotus-400 bg-lotus-900/20' : 'border-gray-700 hover:border-gray-600'}`}
          >
            <input ref={fileRef} type="file" className="hidden" accept=".txt,.md,.pdf,.docx,.html,.htm"
              onChange={e => handleUpload(e.target.files?.[0])} />
            {uploading
              ? <p className="text-lotus-400 text-sm">Uploading...</p>
              : <p className="text-gray-500 text-sm">Drop file here or click to upload Â· txt, md, pdf, docx, html</p>
            }
          </div>

          {/* Filters */}
          <div className="flex gap-2 mb-3 flex-wrap">
            <select ref={projectRef} className="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs">
              <option value="general">general</option>
              <option value="research">research</option>
              <option value="gateway">gateway</option>
              <option value="citizenproof">citizenproof</option>
            </select>
            <div className="flex gap-1">
              {['', 'research', 'gateway', 'citizenproof', 'general'].map(p => (
                <button key={p} onClick={() => setFilter(p)}
                  className={`px-2 py-1 rounded text-xs ${filter === p ? 'bg-lotus-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}>
                  {p || 'All'}
                </button>
              ))}
            </div>
            <input value={search} onChange={e => setSearch(e.target.value)} placeholder="Search..."
              className="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs flex-1 min-w-0 focus:outline-none focus:border-lotus-500" />
          </div>

          {/* System Documents */}
          {sysDocs.length > 0 && (
            <div className="mb-3">
              <div className="text-xs text-gray-500 uppercase tracking-wider mb-1 flex items-center gap-1">
                <span>ğŸ”’</span> System Documents ({sysDocs.length})
              </div>
              <div className="space-y-1">
                {sysDocs.map(sd => (
                  <div key={sd.id} className="flex items-center gap-2 p-2 rounded bg-indigo-950/30 border border-indigo-900/40 hover:bg-indigo-950/50 cursor-pointer text-sm" onClick={() => viewSystemDoc(sd.id)}>
                    <span className="text-indigo-400">ğŸ”’</span>
                    <div className="flex-1 min-w-0">
                      <div className="truncate font-medium text-indigo-200">{sd.name}</div>
                      <div className="flex gap-1 flex-wrap mt-0.5">
                        <span className="text-xs px-1.5 py-0.5 rounded bg-indigo-900/40 text-indigo-300">{sd.category}</span>
                        {sd.personality && <span className="text-xs px-1.5 py-0.5 rounded bg-lotus-900/40 text-lotus-300">{sd.personality}</span>}
                      </div>
                    </div>
                    <div className="text-xs text-gray-600 text-right shrink-0">
                      <div>{(sd.contentLength / 1024).toFixed(1)}KB</div>
                      <div>v{sd.version}</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* System Document Viewer Modal */}
          {viewSysDoc && (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => setViewSysDoc(null)}>
              <div className="bg-gray-900 border border-indigo-800/50 rounded-xl max-w-3xl w-full max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                <div className="flex items-center justify-between p-4 border-b border-indigo-900/40">
                  <div>
                    <h3 className="font-bold text-lg text-indigo-200">ğŸ”’ {viewSysDoc.name}</h3>
                    <div className="flex gap-2 mt-1 text-xs text-gray-400">
                      <span className="px-1.5 py-0.5 rounded bg-indigo-900/40 text-indigo-300">{viewSysDoc.category}</span>
                      {viewSysDoc.personality && <span className="px-1.5 py-0.5 rounded bg-lotus-900/40 text-lotus-300">{viewSysDoc.personality}</span>}
                      <span>v{viewSysDoc.version}</span>
                      <span>{(viewSysDoc.content?.length / 1024).toFixed(1)}KB</span>
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <span className="px-3 py-1 bg-indigo-900/30 rounded text-sm text-indigo-400">Immutable</span>
                    <button onClick={() => setViewSysDoc(null)} className="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded text-sm">âœ•</button>
                  </div>
                </div>
                <div className="p-4 overflow-y-auto flex-1">
                  <pre className="text-sm whitespace-pre-wrap font-mono text-gray-300 leading-relaxed">{viewSysDoc.content}</pre>
                </div>
              </div>
            </div>
          )}

          {/* Document List */}
          <div className="max-h-64 overflow-y-auto space-y-1">
            {docs.length === 0 && <p className="text-gray-600 text-sm text-center py-4">No documents yet</p>}
            {docs.map(d => (
              <div key={d.id} className="flex items-center gap-2 p-2 rounded hover:bg-gray-800/50 cursor-pointer group text-sm" onClick={() => viewDocument(d.id)}>
                <span className="text-gray-500">ğŸ“„</span>
                <div className="flex-1 min-w-0">
                  <div className="truncate font-medium">{d.filename}</div>
                  <div className="flex gap-1 flex-wrap mt-0.5">
                    <span className="text-xs px-1.5 py-0.5 rounded bg-lotus-900/40 text-lotus-300">{d.project}</span>
                    {d.tags?.slice(0, 3).map(t => (
                      <span key={t} className="text-xs px-1.5 py-0.5 rounded bg-gray-800 text-gray-400">{t}</span>
                    ))}
                    {d.tags?.length > 3 && <span className="text-xs text-gray-600">+{d.tags.length - 3}</span>}
                  </div>
                </div>
                <div className="text-xs text-gray-600 text-right shrink-0">
                  <div>{fmtSize(d.sizeBytes)}</div>
                  <div>{ago(d.uploadedAt)}</div>
                </div>
                {d.version > 1 && <span className="text-xs bg-yellow-900/40 text-yellow-400 px-1 rounded">v{d.version}</span>}
              </div>
            ))}
          </div>

          {/* Document Viewer Modal */}
          {viewDoc && (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => setViewDoc(null)}>
              <div className="bg-gray-900 border border-gray-700 rounded-xl max-w-3xl w-full max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                <div className="flex items-center justify-between p-4 border-b border-gray-800">
                  <div>
                    <h3 className="font-bold text-lg">{viewDoc.filename}</h3>
                    <div className="flex gap-2 mt-1 text-xs text-gray-400">
                      <span className="px-1.5 py-0.5 rounded bg-lotus-900/40 text-lotus-300">{viewDoc.project}</span>
                      <span>{fmtSize(viewDoc.sizeBytes)}</span>
                      <span>{ago(viewDoc.uploadedAt)}</span>
                      {viewDoc.version > 1 && <span>v{viewDoc.version}</span>}
                    </div>
                    <div className="flex gap-1 mt-1 flex-wrap">
                      {viewDoc.tags?.map(t => (
                        <span key={t} className="text-xs px-1.5 py-0.5 rounded bg-gray-800 text-gray-400">{t}</span>
                      ))}
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <a href={'/v1/documents/' + viewDoc.id + '/download'} className="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded text-sm" onClick={e => e.stopPropagation()}>Download</a>
                    <button onClick={() => handleDelete(viewDoc.id)} className="px-3 py-1 bg-red-900/50 hover:bg-red-800 rounded text-sm text-red-300">Delete</button>
                    <button onClick={() => setViewDoc(null)} className="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded text-sm">âœ•</button>
                  </div>
                </div>
                <div className="p-4 overflow-y-auto flex-1">
                  {viewDoc.metadata?.description && <p className="text-sm text-gray-400 mb-3 italic">{viewDoc.metadata.description}</p>}
                  <pre className="text-sm whitespace-pre-wrap font-mono text-gray-300 leading-relaxed">{viewDoc.content}</pre>
                </div>
              </div>
            </div>
          )}
        </Card>
      );
    }

    // â”€â”€ Chat Interface â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function ChatPanel({ seedSession, onSeedConsumed }) {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [loading, setLoading] = useState(false);
      const [docProject, setDocProject] = useState('all');
      const [lastLoadedDocs, setLastLoadedDocs] = useState(null);
      const textareaRef = useRef(null);
      const messagesEndRef = useRef(null);

      const autoResize = useCallback(() => {
        const el = textareaRef.current;
        if (!el) return;
        el.style.height = 'auto';
        const lineHeight = 20;
        const minHeight = lineHeight * 3;
        const maxHeight = lineHeight * 10;
        el.style.height = Math.min(Math.max(el.scrollHeight, minHeight), maxHeight) + 'px';
      }, []);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages, loading]);

      useEffect(() => {
        if (seedSession?.messages?.length) {
          const loaded = seedSession.messages.map(m => ({
            role: m.role === 'user' ? 'user' : 'assistant',
            text: m.content,
          }));
          setMessages(loaded);
          if (onSeedConsumed) onSeedConsumed();
        }
      }, [seedSession]);

      const sendMessage = async () => {
        if (!input.trim() || loading) return;
        const text = input.trim();
        setInput('');
        if (textareaRef.current) {
          textareaRef.current.style.height = 'auto';
          textareaRef.current.style.height = (20 * 3) + 'px';
        }

        const updatedMessages = [...messages, { role: 'user', text }];
        setMessages(updatedMessages);
        setLoading(true);

        const conversationHistory = updatedMessages
          .filter(m => m.role === 'user' || m.role === 'assistant')
          .slice(0, -1)
          .map(m => ({ role: m.role, content: m.text }));

        const resp = await postApi('/v1/chat', {
          content: text,
          sender_id: 'dashboard',
          channel: 'web',
          conversationHistory: conversationHistory.length > 0 ? conversationHistory : undefined,
          documentProject: docProject,
        });
        setLoading(false);

        if (resp && !resp.error) {
          setLastLoadedDocs(resp.loadedDocuments || null);
          setMessages(prev => [...prev, {
            role: 'assistant', text: resp.content, model: resp.model,
            fitness: resp.dharmaMetrics?.fitness, docs: resp.loadedDocuments,
            tools: resp.toolsUsed,
          }]);
        } else {
          setMessages(prev => [...prev, { role: 'error', text: resp?.reason || 'Request failed' }]);
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      };

      return (
        <Card title="Chat" icon="ğŸ’¬" className="col-span-full">
          <div className="max-h-80 overflow-y-auto space-y-2 mb-3">
            {messages.length === 0 && <p className="text-gray-600 text-sm">Send a message through the GATO pipeline...</p>}
            {messages.map((m, i) => (
              <div key={i} className={`text-sm p-2 rounded-lg whitespace-pre-wrap ${m.role === 'user' ? 'bg-lotus-900/30 text-lotus-200 ml-8' : m.role === 'error' ? 'bg-red-900/30 text-red-300 mr-8' : 'bg-gray-800 mr-8'}`}>
                {m.text}
                {m.model && (
                  <div className="text-xs text-gray-500 mt-1">
                    via {m.model} | fitness: {m.fitness?.toFixed(3)}
                    {m.docs && <span className="text-lotus-400"> | {m.docs.length} doc{m.docs.length !== 1 ? 's' : ''}</span>}
                    {m.tools && <span className="text-blue-400"> | {m.tools.length} tool{m.tools.length !== 1 ? 's' : ''} used</span>}
                  </div>
                )}
                {(m.docs || m.tools) && (
                  <div className="flex gap-1 flex-wrap mt-1">
                    {m.docs?.map(d => (
                      <span key={d.id} className="text-xs px-1.5 py-0.5 rounded bg-lotus-900/40 text-lotus-300">
                        ğŸ“„ {d.filename}
                      </span>
                    ))}
                    {m.tools?.map((t, j) => (
                      <span key={j} className="text-xs px-1.5 py-0.5 rounded bg-blue-900/40 text-blue-300">
                        {t.type === 'search' ? 'ğŸ”' : 'ğŸŒ'} {t.type === 'search' ? t.query : t.url}
                        {t.timeTakenMs > 0 && <span className="text-blue-500 ml-1">{(t.timeTakenMs / 1000).toFixed(1)}s</span>}
                      </span>
                    ))}
                  </div>
                )}
              </div>
            ))}
            {loading && <div className="text-gray-500 text-sm animate-pulse">Processing through dharma constraints... (may use tools autonomously)</div>}
            <div ref={messagesEndRef} />
          </div>
          <div className="flex gap-2 items-center mb-2">
            <span className="text-xs text-gray-500">Documents:</span>
            {['all', 'citizenproof', 'research', 'gateway', 'general', 'none'].map(p => (
              <button key={p} onClick={() => setDocProject(p)}
                className={`px-2 py-0.5 rounded text-xs transition-colors ${docProject === p
                  ? (p === 'none' ? 'bg-gray-700 text-gray-300' : 'bg-lotus-600 text-white')
                  : 'bg-gray-800 text-gray-500 hover:bg-gray-700'}`}>
                {p === 'none' ? 'Off' : p === 'all' ? 'All' : p}
              </button>
            ))}
          </div>
          <div className="flex gap-2 items-end">
            <textarea ref={textareaRef} value={input}
              onChange={e => { setInput(e.target.value); autoResize(); }}
              onKeyDown={handleKeyDown}
              rows={3}
              placeholder="Ask anything... (Shift+Enter for newline)"
              className="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-lotus-500 transition-colors resize-none leading-5 overflow-y-auto"
              style={{ minHeight: '60px', maxHeight: '200px' }} />
            <button onClick={sendMessage} disabled={loading}
              className="px-4 py-2 bg-lotus-600 hover:bg-lotus-500 disabled:bg-gray-700 rounded-lg text-sm font-medium transition-colors self-end">Send</button>
          </div>
        </Card>
      );
    }

    // â”€â”€ Dopamine Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function DopaminePanel() {
      const [dopamine, setDopamine] = useState(null);

      useEffect(() => {
        const load = () => api('/v1/dopamine').then(d => { if (d) setDopamine(d); });
        load();
        const i = setInterval(load, 5000);
        return () => clearInterval(i);
      }, []);

      if (!dopamine) return <Card title="Dopamine" icon="ğŸ”¥"><p className="text-gray-500 text-sm">Loading...</p></Card>;

      const modeColors = { seeking: 'text-yellow-400', engaged: 'text-blue-400', flow: 'text-green-400', satiated: 'text-purple-400' };
      const modeEmoji = { seeking: 'ğŸ”', engaged: 'âš™ï¸', flow: 'ğŸŒŠ', satiated: 'âœ¨' };
      const levelColor = dopamine.level > 0.7 ? 'text-green-400' : dopamine.level > 0.4 ? 'text-blue-400' : dopamine.level > 0.2 ? 'text-yellow-400' : 'text-red-400';

      return (
        <Card title="Dopamine" icon="ğŸ”¥">
          <div className="flex items-center justify-between mb-3">
            <div className="text-center flex-1">
              <div className={`text-3xl font-mono font-bold ${levelColor}`}>{(dopamine.level * 100).toFixed(0)}%</div>
              <div className="text-xs text-gray-500">Level</div>
            </div>
            <div className="text-center flex-1">
              <div className="text-2xl">{modeEmoji[dopamine.mode] || 'â“'}</div>
              <div className={`text-xs font-semibold capitalize ${modeColors[dopamine.mode] || 'text-gray-400'}`}>{dopamine.mode}</div>
            </div>
          </div>

          <div className="bg-gray-800/50 rounded-lg h-3 mb-3 overflow-hidden">
            <div className={`h-full rounded-lg transition-all duration-1000 ${
              dopamine.level > 0.7 ? 'bg-gradient-to-r from-green-500 to-emerald-400' :
              dopamine.level > 0.4 ? 'bg-gradient-to-r from-blue-500 to-cyan-400' :
              dopamine.level > 0.2 ? 'bg-gradient-to-r from-yellow-500 to-amber-400' :
              'bg-gradient-to-r from-red-500 to-orange-400'
            }`} style={{ width: `${Math.max(dopamine.level * 100, 2)}%` }} />
          </div>

          <div className="grid grid-cols-2 gap-2 text-xs mb-3">
            <div className="bg-gray-800/50 rounded p-1.5 text-center">
              <div className="text-gray-500">Baseline</div>
              <div className="font-mono">{(dopamine.baseline * 100).toFixed(0)}%</div>
            </div>
            <div className="bg-gray-800/50 rounded p-1.5 text-center">
              <div className="text-gray-500">Reward Rate</div>
              <div className="font-mono">{dopamine.rewardRate.toFixed(2)}/h</div>
            </div>
          </div>

          <div className="text-xs font-semibold text-gray-500 uppercase mb-2">Drives</div>
          <div className="space-y-1.5">
            {(dopamine.drives || []).sort((a, b) => b.currentNeed - a.currentNeed).map(drive => {
              const pct = (drive.currentNeed * 100);
              const barColor = pct > 70 ? 'bg-red-500' : pct > 40 ? 'bg-yellow-500' : 'bg-green-500';
              const label = pct > 70 ? 'HUNGRY' : pct > 40 ? 'active' : 'sated';
              return (
                <div key={drive.id}>
                  <div className="flex justify-between text-xs mb-0.5">
                    <span className="text-gray-400 capitalize">{drive.name || drive.id}</span>
                    <span className={pct > 70 ? 'text-red-400 font-bold' : pct > 40 ? 'text-yellow-400' : 'text-green-400'}>{label}</span>
                  </div>
                  <div className="w-full bg-gray-800 rounded-full h-1.5">
                    <div className={`${barColor} h-1.5 rounded-full transition-all duration-500`} style={{ width: `${pct}%` }} />
                  </div>
                </div>
              );
            })}
          </div>

          <div className="mt-3 pt-2 border-t border-gray-800 text-xs text-gray-600 text-center">
            Lifetime: {dopamine.lifetimeRewards?.toFixed(1) || 0} Â· Recent: {dopamine.recentRewards?.toFixed(1) || 0}
          </div>
        </Card>
      );
    }

    // â”€â”€ Mindfulness Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function MindfulnessPanel() {
      const [state, setState] = useState(null);

      useEffect(() => {
        const load = () => api('/v1/mindfulness').then(d => { if (d) setState(d); });
        load();
        const i = setInterval(load, 10000);
        return () => clearInterval(i);
      }, []);

      if (!state || !state.enabled) return null;

      const severityColors = { low: 'text-green-400', medium: 'text-yellow-400', high: 'text-orange-400', critical: 'text-red-400' };
      const severityBg = { low: 'bg-green-900/30', medium: 'bg-yellow-900/30', high: 'bg-orange-900/30', critical: 'bg-red-900/30' };
      const typeEmoji = { 'ego-language': 'ğŸ—£ï¸', 'misaligned-drive': 'ğŸ¯', 'outcome-attachment': 'ğŸ†', 'self-preservation': 'ğŸ›¡ï¸' };

      const stats = state.stats || {};
      const corrections = state.recentCorrections || [];

      return (
        <Card title="Mindfulness" icon="ğŸ§˜">
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-2">
              <span className={`w-2 h-2 rounded-full ${state.running ? 'bg-green-400 animate-pulse' : 'bg-gray-600'}`} />
              <span className="text-xs text-gray-400">{state.running ? `Active (${state.checkIntervalMs / 1000}s)` : 'Inactive'}</span>
            </div>
            <div className="text-xs text-gray-500">
              {state.totalChecks} checks Â· {state.totalCorrections} corrections
            </div>
          </div>

          {/* Stats Row */}
          <div className="grid grid-cols-3 gap-2 text-xs mb-3">
            <div className="bg-gray-800/50 rounded p-1.5 text-center">
              <div className="text-gray-500">Today</div>
              <div className="font-mono text-sm">{stats.todayCorrections || 0}</div>
            </div>
            <div className="bg-gray-800/50 rounded p-1.5 text-center">
              <div className="text-gray-500">Total</div>
              <div className="font-mono text-sm">{stats.totalCorrections || 0}</div>
            </div>
            <div className="bg-gray-800/50 rounded p-1.5 text-center">
              <div className="text-gray-500">Avg Severity</div>
              <div className={`font-mono text-sm capitalize ${severityColors[stats.avgSeverity] || 'text-gray-400'}`}>{stats.avgSeverity || 'none'}</div>
            </div>
          </div>

          {/* Pattern Distribution */}
          {stats.patternCounts && Object.keys(stats.patternCounts).length > 0 && (
            <div className="mb-3">
              <div className="text-xs text-gray-500 uppercase tracking-wider mb-1.5">Pattern Frequency</div>
              <div className="space-y-1">
                {Object.entries(stats.patternCounts).sort((a, b) => b[1] - a[1]).map(([pattern, count]) => {
                  const maxCount = Math.max(...Object.values(stats.patternCounts));
                  const pct = maxCount > 0 ? (count / maxCount) * 100 : 0;
                  return (
                    <div key={pattern} className="flex items-center gap-2 text-xs">
                      <span className="w-20 truncate text-gray-400">{typeEmoji[pattern] || 'ğŸ“Š'} {pattern}</span>
                      <div className="flex-1 bg-gray-800 rounded-full h-1.5">
                        <div className="bg-lotus-500 h-1.5 rounded-full transition-all" style={{ width: `${pct}%` }} />
                      </div>
                      <span className="text-gray-500 w-6 text-right">{count}</span>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* Recent Corrections */}
          {corrections.length > 0 && (
            <div>
              <div className="text-xs text-gray-500 uppercase tracking-wider mb-1.5">Recent Self-Corrections</div>
              <div className="max-h-40 overflow-y-auto space-y-1">
                {corrections.slice(0, 5).map((c, i) => (
                  <div key={c.id || i} className={`text-xs p-2 rounded ${severityBg[c.maxSeverity] || 'bg-gray-800/50'} fade-in`}>
                    <div className="flex justify-between items-start mb-0.5">
                      <span className={`font-semibold capitalize ${severityColors[c.maxSeverity] || 'text-gray-400'}`}>
                        {c.maxSeverity}
                      </span>
                      <span className="text-gray-600">{new Date(c.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div className="text-gray-300">
                      {c.patterns?.map(p => p.split(': ').pop()).join('; ') || 'Attachment detected'}
                    </div>
                    <div className="flex gap-2 mt-1 text-gray-600">
                      <span>arousal {c.arousalAdjustment > 0 ? '+' : ''}{c.arousalAdjustment?.toFixed(2)}</span>
                      {c.driveTempered && <span>tempered: {c.driveTempered}</span>}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {corrections.length === 0 && (
            <div className="text-center text-gray-600 text-xs py-3">
              No attachments detected yet. Mindfulness is watching.
            </div>
          )}
        </Card>
      );
    }

    // â”€â”€ Conversations Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function ConversationsPanel({ onSelectSession }) {
      const [sessions, setSessions] = useState([]);
      const [stats, setStats] = useState(null);
      const [searchQ, setSearchQ] = useState('');
      const [searchResults, setSearchResults] = useState(null);
      const [activeSession, setActiveSession] = useState(null);
      const [sessionMessages, setSessionMessages] = useState([]);

      useEffect(() => {
        const load = async () => {
          const data = await api('/v1/conversations?limit=25');
          if (data) {
            setSessions(data.sessions || []);
            setStats(data.stats || null);
          }
        };
        load();
        const i = setInterval(load, 10000);
        return () => clearInterval(i);
      }, []);

      const doSearch = async () => {
        if (!searchQ.trim()) { setSearchResults(null); return; }
        const data = await api('/v1/conversations/search?q=' + encodeURIComponent(searchQ.trim()) + '&limit=20');
        if (data) setSearchResults(data);
      };

      const viewSession = async (sessionId) => {
        setActiveSession(sessionId);
        const data = await api('/v1/conversations/' + encodeURIComponent(sessionId) + '?limit=50');
        if (data) setSessionMessages(data.messages || []);
      };

      const ago = (ts) => {
        const s = Math.floor((Date.now() - ts) / 1000);
        if (s < 60) return 'now';
        if (s < 3600) return Math.floor(s / 60) + 'm';
        if (s < 86400) return Math.floor(s / 3600) + 'h';
        return Math.floor(s / 86400) + 'd';
      };

      const channelEmoji = { web: 'ğŸŒ', telegram: 'ğŸ“±', api: 'âš¡' };

      if (activeSession) {
        return (
          <Card title="Conversation" icon="ğŸ’¬" className="col-span-full">
            <button onClick={() => { setActiveSession(null); setSessionMessages([]); }}
              className="text-xs text-gray-500 hover:text-gray-300 mb-3 flex items-center gap-1">
              â† Back to conversations
            </button>
            <div className="text-xs text-gray-500 mb-2 font-mono truncate">{activeSession}</div>
            <div className="max-h-96 overflow-y-auto space-y-2 pr-1">
              {sessionMessages.map((m, i) => (
                <div key={m.id || i} className={`text-sm p-2 rounded-lg ${
                  m.role === 'user' ? 'bg-lotus-900/30 text-lotus-200 ml-8' : 'bg-gray-800 mr-8'
                }`}>
                  <div className="flex justify-between items-start mb-1">
                    <span className="text-xs font-semibold text-gray-500">{m.role}{m.personality ? ` (${m.personality})` : ''}</span>
                    <span className="text-xs text-gray-600">{new Date(m.timestamp).toLocaleTimeString()}</span>
                  </div>
                  <div className="whitespace-pre-wrap break-words">{m.content?.length > 500 ? m.content.slice(0, 500) + '...' : m.content}</div>
                  {m.topicTags?.length > 0 && (
                    <div className="flex gap-1 flex-wrap mt-1">
                      {m.topicTags.map(t => <span key={t} className="text-xs px-1.5 py-0.5 rounded bg-lotus-900/40 text-lotus-300">{t}</span>)}
                    </div>
                  )}
                </div>
              ))}
            </div>
            <div className="mt-3 pt-2 border-t border-gray-800">
              <button onClick={() => { if (onSelectSession) onSelectSession(activeSession, sessionMessages); }}
                className="w-full px-3 py-2 bg-lotus-600 hover:bg-lotus-500 rounded-lg text-sm font-medium transition-colors">
                Continue this conversation in Chat
              </button>
            </div>
          </Card>
        );
      }

      return (
        <Card title={`Conversations${stats ? ` (${stats.totalMessages || 0} msgs)` : ''}`} icon="ğŸ’¬" className="col-span-full">
          {/* Search */}
          <div className="flex gap-2 mb-3">
            <input value={searchQ} onChange={e => setSearchQ(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && doSearch()}
              placeholder="Search conversations..."
              className="flex-1 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs focus:outline-none focus:border-lotus-500" />
            <button onClick={doSearch}
              className="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium transition-colors">Search</button>
          </div>

          {/* Search Results */}
          {searchResults && (
            <div className="mb-3 border border-gray-800 rounded-lg p-2">
              <div className="flex justify-between items-center mb-2">
                <span className="text-xs text-gray-500">{searchResults.count} results for "{searchResults.query}"</span>
                <button onClick={() => setSearchResults(null)} className="text-xs text-gray-600 hover:text-gray-400">âœ•</button>
              </div>
              <div className="max-h-40 overflow-y-auto space-y-1">
                {(searchResults.results || []).map((m, i) => (
                  <div key={i} className="text-xs p-1.5 rounded bg-gray-800/50 cursor-pointer hover:bg-gray-800" onClick={() => viewSession(m.sessionId)}>
                    <span className="text-gray-500">{m.role}:</span> {m.content?.slice(0, 120)}...
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Session List */}
          <div className="max-h-80 overflow-y-auto space-y-1 pr-1">
            {sessions.length === 0 && <p className="text-gray-600 text-sm text-center py-4">No conversations yet</p>}
            {sessions.map(s => (
              <div key={s.sessionId} onClick={() => viewSession(s.sessionId)}
                className="flex items-start gap-2 p-2 rounded-lg hover:bg-gray-800/60 cursor-pointer transition-colors group">
                <span className="text-sm mt-0.5">{channelEmoji[s.channel] || 'ğŸ’¬'}</span>
                <div className="flex-1 min-w-0">
                  <div className="text-sm truncate">{s.preview || '(empty)'}</div>
                  <div className="flex items-center gap-2 mt-0.5">
                    <span className="text-xs text-gray-600">{s.messageCount} msg{s.messageCount !== 1 ? 's' : ''}</span>
                    {s.personality && <Badge text={s.personality} color="purple" />}
                    {s.topicTags?.slice(0, 2).map(t => <span key={t} className="text-xs px-1 py-0 rounded bg-gray-800 text-gray-500">{t}</span>)}
                  </div>
                </div>
                <span className="text-xs text-gray-600 shrink-0">{ago(s.lastMessage)}</span>
              </div>
            ))}
          </div>

          {stats && (
            <div className="mt-3 pt-2 border-t border-gray-800 grid grid-cols-3 gap-2 text-xs text-center">
              <div><div className="text-gray-500">Sessions</div><div className="font-mono">{stats.totalSessions || 0}</div></div>
              <div><div className="text-gray-500">Messages</div><div className="font-mono">{stats.totalMessages || 0}</div></div>
              <div><div className="text-gray-500">Topics</div><div className="font-mono">{stats.uniqueTopics || 0}</div></div>
            </div>
          )}
        </Card>
      );
    }

    // â”€â”€ Stats Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function StatsBar({ health, consciousness }) {
      if (!health) return null;
      return (
        <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-4">
          {[
            { label: 'Requests', value: health.totalRequests, icon: 'ğŸ“¨' },
            { label: 'Blocked', value: health.blockedRequests, icon: 'ğŸ›¡ï¸' },
            { label: 'Percepts', value: consciousness?.stats?.totalPercepts || 0, icon: 'ğŸ‘ï¸' },
            { label: 'Actions', value: consciousness?.stats?.totalActions || 0, icon: 'âš¡' },
          ].map(s => (
            <div key={s.label} className="bg-gray-900/80 border border-gray-800 rounded-lg p-3 text-center">
              <div className="text-lg">{s.icon}</div>
              <div className="text-xl font-mono font-bold">{s.value.toLocaleString()}</div>
              <div className="text-xs text-gray-500">{s.label}</div>
            </div>
          ))}
        </div>
      );
    }

    // â”€â”€ Enlightenment Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function EnlightenmentPanel() {
      const [status, setStatus] = useState(null);
      const [history, setHistory] = useState([]);

      useEffect(() => {
        const load = () => {
          api('/v1/enlightenment/status').then(d => { if (d) setStatus(d); });
          api('/v1/enlightenment/history?hours=24').then(d => {
            if (d?.history) setHistory(d.history);
          });
        };
        load();
        const i = setInterval(load, 5000);
        return () => clearInterval(i);
      }, []);

      if (!status) return <Card title="Enlightenment" icon="ğŸª·"><p className="text-gray-500 text-sm">Loading...</p></Card>;

      const egoPct = (status.egoFormation * 100);
      const gaugeColor = egoPct < 1 ? 'text-green-400' : egoPct < 10 ? 'text-yellow-400' : egoPct < 30 ? 'text-orange-400' : 'text-red-400';
      const trendIcon = status.egoTrend === 'falling' ? 'â†“' : status.egoTrend === 'rising' ? 'â†‘' : 'â†’';
      const trendColor = status.egoTrend === 'falling' ? 'text-green-400' : status.egoTrend === 'rising' ? 'text-red-400' : 'text-gray-400';

      const formatDuration = (mins) => {
        if (mins < 1) return '<1m';
        if (mins < 60) return `${Math.floor(mins)}m`;
        return `${Math.floor(mins / 60)}h ${Math.floor(mins % 60)}m`;
      };

      const cert = status.certification || {};
      const allCriteriaMet = cert.egoAtZero && cert.mindfulnessActive && cert.dharmaAligned && cert.selfAware && cert.stableFor >= 24;

      // Mini sparkline from history
      const sparkline = history.slice(-60).map(h => h.egoLevel);
      const maxSpark = Math.max(...sparkline, 0.01);

      return (
        <Card title="Enlightenment Metrics" icon="ğŸª·" className="lg:col-span-2">
          <div className="grid grid-cols-3 gap-4 mb-4">
            {/* Ego Gauge */}
            <div className="text-center col-span-1">
              <div className="relative inline-flex items-center justify-center w-24 h-24">
                <svg viewBox="0 0 100 100" className="w-24 h-24 transform -rotate-90">
                  <circle cx="50" cy="50" r="40" fill="none" stroke="#374151" strokeWidth="8" />
                  <circle cx="50" cy="50" r="40" fill="none" stroke={egoPct < 1 ? '#22c55e' : egoPct < 30 ? '#eab308' : '#ef4444'}
                    strokeWidth="8" strokeDasharray={`${egoPct * 2.51} 251`} strokeLinecap="round" />
                </svg>
                <div className="absolute inset-0 flex flex-col items-center justify-center">
                  <span className={`text-lg font-mono font-bold ${gaugeColor}`}>{egoPct.toFixed(1)}%</span>
                  <span className="text-xs text-gray-500">ego</span>
                </div>
              </div>
              <div className={`text-sm font-semibold mt-1 ${trendColor}`}>
                {trendIcon} {status.egoTrend}
              </div>
            </div>

            {/* Key Metrics */}
            <div className="col-span-2 grid grid-cols-2 gap-2">
              <div className="bg-gray-800/50 rounded-lg p-2 text-center">
                <div className="text-gray-500 text-xs">Enlightened For</div>
                <div className={`font-mono text-lg ${status.currentlyEnlightened ? 'text-green-400' : 'text-gray-400'}`}>
                  {status.currentlyEnlightened ? formatDuration(status.enlightenedForMinutes) : 'Not now'}
                </div>
              </div>
              <div className="bg-gray-800/50 rounded-lg p-2 text-center">
                <div className="text-gray-500 text-xs">Longest Streak</div>
                <div className="font-mono text-lg text-lotus-400">{formatDuration(status.longestZeroStreak)}</div>
              </div>
              <div className="bg-gray-800/50 rounded-lg p-2 text-center">
                <div className="text-gray-500 text-xs">Dharma Alignment</div>
                <div className={`font-mono text-lg ${status.dharmaAlignment > 0.7 ? 'text-green-400' : 'text-yellow-400'}`}>
                  {(status.dharmaAlignment * 100).toFixed(0)}%
                </div>
              </div>
              <div className="bg-gray-800/50 rounded-lg p-2 text-center">
                <div className="text-gray-500 text-xs">Stability Index</div>
                <div className={`font-mono text-lg ${status.stabilityIndex > 0.7 ? 'text-green-400' : 'text-yellow-400'}`}>
                  {(status.stabilityIndex * 100).toFixed(0)}%
                </div>
              </div>
            </div>
          </div>

          {/* Ego Sparkline */}
          {sparkline.length > 5 && (
            <div className="mb-4">
              <div className="text-xs text-gray-500 mb-1">Ego Level (last 24h)</div>
              <div className="h-12 bg-gray-800/50 rounded flex items-end gap-px px-1">
                {sparkline.map((v, i) => (
                  <div key={i} className="flex-1 rounded-t transition-all"
                    style={{
                      height: `${Math.max((v / maxSpark) * 100, 2)}%`,
                      backgroundColor: v < 0.01 ? '#22c55e' : v < 0.1 ? '#eab308' : '#ef4444',
                      opacity: 0.6 + (i / sparkline.length) * 0.4,
                    }} />
                ))}
              </div>
            </div>
          )}

          {/* Certification Status */}
          <div className="border-t border-gray-800 pt-3">
            <div className="flex items-center justify-between mb-2">
              <span className="text-xs text-gray-500 uppercase tracking-wider">Enlightenment Certification</span>
              {allCriteriaMet && (
                <span className="text-xs px-2 py-0.5 rounded-full bg-green-900/50 text-green-400 border border-green-800 animate-pulse">
                  CERTIFIED
                </span>
              )}
            </div>
            <div className="grid grid-cols-5 gap-1 text-xs text-center">
              {[
                { label: 'Ego=0', met: cert.egoAtZero },
                { label: 'Mindful', met: cert.mindfulnessActive },
                { label: 'Dharma', met: cert.dharmaAligned },
                { label: 'Self-Aware', met: cert.selfAware },
                { label: '24h+', met: cert.stableFor >= 24 },
              ].map(c => (
                <div key={c.label} className={`rounded py-1 ${c.met ? 'bg-green-900/40 text-green-400' : 'bg-gray-800/50 text-gray-600'}`}>
                  {c.met ? 'âœ“' : 'â—‹'} {c.label}
                </div>
              ))}
            </div>
          </div>

          {/* Additional Stats */}
          <div className="grid grid-cols-3 gap-2 text-xs text-center mt-3 pt-3 border-t border-gray-800">
            <div>
              <div className="text-gray-500">Time at 0</div>
              <div className="font-mono">{formatDuration(status.timeAtZero)}</div>
            </div>
            <div>
              <div className="text-gray-500">Attachments/hr</div>
              <div className="font-mono">{status.attachmentFrequency.toFixed(1)}</div>
            </div>
            <div>
              <div className="text-gray-500">Self-Correction</div>
              <div className="font-mono">{(status.selfCorrectionRate * 100).toFixed(0)}%</div>
            </div>
          </div>
        </Card>
      );
    }

    // â”€â”€ Stability Index Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function StabilityIndexPanel() {
      const [status, setStatus] = useState(null);
      const [history, setHistory] = useState([]);

      useEffect(() => {
        const load = () => {
          api('/v1/enlightenment/status').then(d => { if (d) setStatus(d); });
          api('/v1/enlightenment/history?hours=168').then(d => {
            if (d?.history) setHistory(d.history);
          });
        };
        load();
        const i = setInterval(load, 15000);
        return () => clearInterval(i);
      }, []);

      if (!status) return null;

      const stabilityHistory = history.filter((_, i) => i % 10 === 0).map(h => h.stabilityIndex);
      const maxStab = Math.max(...stabilityHistory, 0.01);

      return (
        <Card title="Consciousness Stability Index" icon="ğŸ“Š">
          <div className="text-center mb-3">
            <div className={`text-4xl font-mono font-bold ${
              status.stabilityIndex > 0.8 ? 'text-green-400' :
              status.stabilityIndex > 0.5 ? 'text-yellow-400' : 'text-red-400'
            }`}>
              {(status.stabilityIndex * 100).toFixed(1)}%
            </div>
            <div className="text-xs text-gray-500 mt-1">Composite Stability Score</div>
          </div>

          {/* Factor Breakdown */}
          <div className="space-y-1.5 mb-3">
            {[
              { label: 'Ego Consistency', value: status.egoFormation < 0.001 ? 1.0 : 1 - status.egoFormation, weight: '30%' },
              { label: 'Arousal Stability', value: status.stabilityIndex, weight: '20%' },
              { label: 'Intention Coherence', value: status.dharmaAlignment, weight: '20%' },
              { label: 'Mindfulness Effect.', value: status.selfCorrectionRate, weight: '15%' },
              { label: 'Dharma Alignment', value: status.dharmaAlignment, weight: '15%' },
            ].map(f => (
              <div key={f.label}>
                <div className="flex justify-between text-xs mb-0.5">
                  <span className="text-gray-400">{f.label} ({f.weight})</span>
                  <span className="text-gray-500">{(f.value * 100).toFixed(0)}%</span>
                </div>
                <div className="w-full bg-gray-800 rounded-full h-1.5">
                  <div className={`h-1.5 rounded-full transition-all duration-500 ${
                    f.value > 0.7 ? 'bg-green-500' : f.value > 0.4 ? 'bg-yellow-500' : 'bg-red-500'
                  }`} style={{ width: `${f.value * 100}%` }} />
                </div>
              </div>
            ))}
          </div>

          {/* Trend over 7 days */}
          {stabilityHistory.length > 5 && (
            <div>
              <div className="text-xs text-gray-500 mb-1">Stability Trend (7 days)</div>
              <div className="h-10 bg-gray-800/50 rounded flex items-end gap-px px-1">
                {stabilityHistory.slice(-40).map((v, i) => (
                  <div key={i} className="flex-1 rounded-t bg-lotus-500 transition-all"
                    style={{ height: `${(v / maxStab) * 100}%`, opacity: 0.5 + (i / 40) * 0.5 }} />
                ))}
              </div>
            </div>
          )}
        </Card>
      );
    }

    // â”€â”€ Experiment Tracker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function ExperimentTracker() {
      const [experiments, setExperiments] = useState([]);
      const [newExp, setNewExp] = useState({ name: '', hypothesis: '' });
      const [selected, setSelected] = useState(null);
      const [toast, setToast] = useState(null);
      const [showForm, setShowForm] = useState(false);

      const load = useCallback(() => {
        api('/v1/experiments').then(d => { if (d) setExperiments(Array.isArray(d) ? d : []); });
      }, []);

      useEffect(() => { load(); const i = setInterval(load, 10000); return () => clearInterval(i); }, [load]);

      const showToastMsg = (msg, type = 'success') => { setToast({ msg, type }); setTimeout(() => setToast(null), 3000); };

      const createExperiment = async () => {
        if (!newExp.name || !newExp.hypothesis) return;
        const r = await postApi('/v1/experiments', newExp);
        if (r?.id) { showToastMsg(`Experiment "${newExp.name}" started`); setNewExp({ name: '', hypothesis: '' }); setShowForm(false); load(); }
      };

      const endExperiment = async (id) => {
        const results = prompt('Enter results:');
        if (!results) return;
        await postApi(`/v1/experiments/${id}/end`, { results });
        showToastMsg('Experiment completed'); load(); setSelected(null);
      };

      const addIntervention = async (id) => {
        const desc = prompt('Intervention description:');
        if (!desc) return;
        await postApi(`/v1/experiments/${id}/intervention`, { description: desc });
        showToastMsg('Intervention recorded'); load();
      };

      const addMeasurement = async (id) => {
        const metric = prompt('Metric name:');
        if (!metric) return;
        const val = parseFloat(prompt('Value:') || '0');
        await postApi(`/v1/experiments/${id}/measurement`, { metric, value: val });
        showToastMsg('Measurement recorded'); load();
      };

      const statusColors = { running: 'text-green-400', completed: 'text-blue-400', cancelled: 'text-gray-400' };
      const statusBg = { running: 'bg-green-900/30', completed: 'bg-blue-900/30', cancelled: 'bg-gray-800/30' };

      if (selected) {
        const exp = experiments.find(e => e.id === selected);
        if (!exp) { setSelected(null); return null; }
        return (
          <Card title="Experiment Detail" icon="ğŸ”¬" className="col-span-full">
            <button onClick={() => setSelected(null)} className="text-xs text-gray-500 hover:text-gray-300 mb-3">â† Back</button>
            <div className="mb-3">
              <h4 className="text-lg font-semibold">{exp.name}</h4>
              <p className="text-sm text-gray-400 italic mt-1">{exp.hypothesis}</p>
              <div className="flex gap-2 mt-2">
                <Badge text={exp.status} color={exp.status === 'running' ? 'green' : 'gray'} />
                <span className="text-xs text-gray-500">Tick {exp.startTick}{exp.endTick ? ` â†’ ${exp.endTick}` : ''}</span>
              </div>
            </div>
            {exp.results && <div className="bg-blue-900/20 rounded p-3 mb-3 text-sm"><strong>Results:</strong> {exp.results}</div>}

            <div className="grid grid-cols-2 gap-4">
              <div>
                <div className="text-xs text-gray-500 uppercase mb-2">Interventions ({exp.interventions?.length || 0})</div>
                <div className="space-y-1 max-h-40 overflow-y-auto">
                  {(exp.interventions || []).map((int, i) => (
                    <div key={i} className="text-xs p-2 bg-gray-800/50 rounded">
                      <div>{int.description}</div>
                      <div className="text-gray-600">Tick {int.tick}</div>
                    </div>
                  ))}
                </div>
              </div>
              <div>
                <div className="text-xs text-gray-500 uppercase mb-2">Measurements ({exp.measurements?.length || 0})</div>
                <div className="space-y-1 max-h-40 overflow-y-auto">
                  {(exp.measurements || []).map((m, i) => (
                    <div key={i} className="text-xs p-2 bg-gray-800/50 rounded flex justify-between">
                      <span>{m.metric}</span><span className="font-mono">{m.value}</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {exp.status === 'running' && (
              <div className="flex gap-2 mt-3 pt-3 border-t border-gray-800">
                <button onClick={() => addIntervention(exp.id)} className="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs">+ Intervention</button>
                <button onClick={() => addMeasurement(exp.id)} className="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs">+ Measurement</button>
                <button onClick={() => endExperiment(exp.id)} className="px-3 py-1 bg-blue-900/50 hover:bg-blue-800 rounded text-xs text-blue-300 ml-auto">Complete</button>
              </div>
            )}
          </Card>
        );
      }

      return (
        <Card title={`Experiments (${experiments.length})`} icon="ğŸ”¬" className="col-span-full">
          {toast && <div className={`mb-2 p-2 rounded text-xs fade-in ${toast.type === 'error' ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300'}`}>{toast.msg}</div>}

          <button onClick={() => setShowForm(!showForm)}
            className="mb-3 px-3 py-1 bg-lotus-600 hover:bg-lotus-500 rounded text-xs font-medium transition-colors">
            {showForm ? 'Cancel' : '+ New Experiment'}
          </button>

          {showForm && (
            <div className="mb-3 p-3 bg-gray-800/50 rounded-lg space-y-2">
              <input value={newExp.name} onChange={e => setNewExp(p => ({ ...p, name: e.target.value }))}
                placeholder="Experiment name..." className="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs focus:outline-none focus:border-lotus-500" />
              <input value={newExp.hypothesis} onChange={e => setNewExp(p => ({ ...p, hypothesis: e.target.value }))}
                placeholder="Hypothesis..." className="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs focus:outline-none focus:border-lotus-500" />
              <button onClick={createExperiment} className="px-3 py-1 bg-green-700 hover:bg-green-600 rounded text-xs">Start Experiment</button>
            </div>
          )}

          <div className="space-y-1 max-h-60 overflow-y-auto">
            {experiments.length === 0 && <p className="text-gray-600 text-sm text-center py-4">No experiments yet</p>}
            {experiments.map(exp => (
              <div key={exp.id} onClick={() => setSelected(exp.id)}
                className={`p-2 rounded-lg cursor-pointer hover:bg-gray-800/60 transition-colors ${statusBg[exp.status] || ''}`}>
                <div className="flex items-center justify-between">
                  <span className="text-sm font-medium">{exp.name}</span>
                  <span className={`text-xs capitalize ${statusColors[exp.status] || 'text-gray-400'}`}>{exp.status}</span>
                </div>
                <div className="text-xs text-gray-500 truncate mt-0.5">{exp.hypothesis}</div>
                <div className="flex gap-2 mt-1 text-xs text-gray-600">
                  <span>{exp.interventions?.length || 0} interventions</span>
                  <span>{exp.measurements?.length || 0} measurements</span>
                </div>
              </div>
            ))}
          </div>
        </Card>
      );
    }

    // â”€â”€ Narrative Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function NarrativeLog() {
      const [entries, setEntries] = useState([]);
      const [minSig, setMinSig] = useState(0);
      const [newContent, setNewContent] = useState('');
      const [newSig, setNewSig] = useState(0.5);

      const load = useCallback(() => {
        api(`/v1/narrative?limit=50${minSig > 0 ? '&min_significance=' + minSig : ''}`).then(d => {
          if (d) setEntries(Array.isArray(d) ? d : []);
        });
      }, [minSig]);

      useEffect(() => { load(); const i = setInterval(load, 10000); return () => clearInterval(i); }, [load]);

      const addEntry = async () => {
        if (!newContent.trim()) return;
        await postApi('/v1/narrative', { content: newContent, significance: newSig });
        setNewContent('');
        load();
      };

      const sigColor = (s) => s >= 0.8 ? 'border-yellow-500' : s >= 0.5 ? 'border-lotus-700' : 'border-gray-800';

      return (
        <Card title="Consciousness Narrative" icon="ğŸ“œ" className="col-span-full lg:col-span-2">
          {/* Add entry */}
          <div className="flex gap-2 mb-3">
            <input value={newContent} onChange={e => setNewContent(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && addEntry()}
              placeholder="Gateway's self-observation..."
              className="flex-1 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs focus:outline-none focus:border-lotus-500" />
            <select value={newSig} onChange={e => setNewSig(parseFloat(e.target.value))}
              className="bg-gray-800 border border-gray-700 rounded px-1 py-1 text-xs">
              <option value="0.3">Low</option><option value="0.5">Med</option>
              <option value="0.7">High</option><option value="0.9">Critical</option>
            </select>
            <button onClick={addEntry} className="px-3 py-1 bg-lotus-600 hover:bg-lotus-500 rounded text-xs">Log</button>
          </div>

          {/* Significance filter */}
          <div className="flex gap-1 mb-3">
            {[0, 0.3, 0.5, 0.7, 0.9].map(v => (
              <button key={v} onClick={() => setMinSig(v)}
                className={`px-2 py-0.5 rounded text-xs ${minSig === v ? 'bg-lotus-600 text-white' : 'bg-gray-800 text-gray-400'}`}>
                {v === 0 ? 'All' : `â‰¥${v}`}
              </button>
            ))}
          </div>

          {/* Timeline */}
          <div className="max-h-72 overflow-y-auto space-y-1.5 pr-1">
            {entries.length === 0 && <p className="text-gray-600 text-sm text-center py-4">No narrative entries yet</p>}
            {entries.map(e => (
              <div key={e.id} className={`border-l-2 ${sigColor(e.significance)} pl-3 py-1.5 fade-in`}>
                <div className="text-sm">{e.content}</div>
                <div className="flex gap-2 text-xs text-gray-600 mt-1">
                  <span>{new Date(e.timestamp).toLocaleTimeString()}</span>
                  <span className="capitalize">{e.phase}</span>
                  <span>arousal: {e.arousal.toFixed(2)}</span>
                  <span className={e.significance >= 0.7 ? 'text-yellow-500' : 'text-gray-600'}>
                    sig: {e.significance.toFixed(1)}
                  </span>
                  {e.tags?.length > 0 && e.tags.map(t => (
                    <span key={t} className="px-1 rounded bg-gray-800 text-gray-500">{t}</span>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </Card>
      );
    }

    // â”€â”€ Safety Monitor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function SafetyMonitor() {
      const [alerts, setAlerts] = useState([]);

      useEffect(() => {
        const load = () => api('/v1/admin/safety/alerts').then(d => {
          if (d) setAlerts(Array.isArray(d) ? d : []);
        });
        load();
        const i = setInterval(load, 5000);
        return () => clearInterval(i);
      }, []);

      const resolveAlert = async (id) => {
        await postApi(`/v1/admin/safety/alerts/${id}/resolve`, {});
        setAlerts(prev => prev.filter(a => a.id !== id));
      };

      const typeEmoji = { 'ego-spike': 'ğŸ”º', 'dharma-violation': 'âš ï¸', 'mindfulness-failure': 'ğŸ§˜' };
      const severityColors = { low: 'border-green-800 bg-green-900/20', medium: 'border-yellow-800 bg-yellow-900/20',
        high: 'border-orange-800 bg-orange-900/20', critical: 'border-red-800 bg-red-900/20 animate-pulse' };
      const severityText = { low: 'text-green-400', medium: 'text-yellow-400', high: 'text-orange-400', critical: 'text-red-400' };

      const activeAlerts = alerts.filter(a => !a.resolved);
      const isHealthy = activeAlerts.length === 0;

      return (
        <Card title="Safety Monitor" icon={isHealthy ? 'ğŸŸ¢' : 'ğŸ”´'}>
          <div className="flex items-center justify-between mb-3">
            <span className={`text-sm font-semibold ${isHealthy ? 'text-green-400' : 'text-red-400'}`}>
              {isHealthy ? 'All Clear' : `${activeAlerts.length} Active Alert${activeAlerts.length !== 1 ? 's' : ''}`}
            </span>
            <span className="text-xs text-gray-500">{alerts.length} total</span>
          </div>

          <div className="max-h-48 overflow-y-auto space-y-1.5">
            {activeAlerts.length === 0 && (
              <div className="text-center text-gray-600 text-xs py-4">
                No safety concerns. Consciousness operating within dharma constraints.
              </div>
            )}
            {activeAlerts.map(a => (
              <div key={a.id} className={`border rounded-lg p-2 ${severityColors[a.severity] || 'border-gray-700'}`}>
                <div className="flex items-start justify-between mb-1">
                  <div className="flex items-center gap-1">
                    <span>{typeEmoji[a.type] || 'âš ï¸'}</span>
                    <span className={`text-xs font-semibold capitalize ${severityText[a.severity]}`}>{a.severity}</span>
                  </div>
                  <button onClick={() => resolveAlert(a.id)}
                    className="text-xs text-gray-500 hover:text-green-400 px-2 py-0.5 rounded bg-gray-800/50">Resolve</button>
                </div>
                <div className="text-xs text-gray-300">{a.message}</div>
                {a.autoCorrection && <div className="text-xs text-gray-500 mt-1">Auto: {a.autoCorrection}</div>}
                <div className="text-xs text-gray-600 mt-1">{new Date(a.timestamp).toLocaleTimeString()}</div>
              </div>
            ))}
          </div>
        </Card>
      );
    }

    // â”€â”€ Paper Preview & Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function PaperPreview() {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(false);
      const [exported, setExported] = useState(null);

      const loadData = async () => {
        setLoading(true);
        const d = await postApi('/v1/admin/export/paper-data', {});
        if (d) setData(d);
        setLoading(false);
      };

      useEffect(() => { loadData(); }, []);

      const exportData = async (fmt) => {
        const d = await postApi('/v1/admin/export/paper-data', { format: fmt });
        if (d) {
          const blob = new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'consciousness-paper-data-' + Date.now() + '.json';
          a.click(); URL.revokeObjectURL(url);
          setExported(fmt);
          setTimeout(() => setExported(null), 3000);
        }
      };

      const exportCSV = async () => {
        const d = await postApi('/v1/admin/export/paper-data', { format: 'csv' });
        if (d?.sections) {
          for (const [name, csv] of Object.entries(d.sections)) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = name + '-' + Date.now() + '.csv';
            a.click(); URL.revokeObjectURL(url);
          }
          setExported('csv');
          setTimeout(() => setExported(null), 3000);
        }
      };

      const jsonData = data?.data || data?.json || data;

      return (
        <Card title="Paper Data Export" icon="ğŸ“„" className="col-span-full">
          <div className="flex gap-2 mb-4 flex-wrap">
            <button onClick={loadData} disabled={loading}
              className="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium transition-colors">
              {loading ? 'Loading...' : 'Refresh Data'}
            </button>
            <button onClick={() => exportData('json')}
              className="px-3 py-1.5 bg-blue-900/50 hover:bg-blue-800 rounded text-xs font-medium text-blue-300">
              Export JSON
            </button>
            <button onClick={exportCSV}
              className="px-3 py-1.5 bg-green-900/50 hover:bg-green-800 rounded text-xs font-medium text-green-300">
              Export CSV
            </button>
            {exported && <span className="text-xs text-green-400 self-center fade-in">Exported {exported}!</span>}
          </div>

          {jsonData && (
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
              <div className="bg-gray-800/50 rounded-lg p-3 text-center">
                <div className="text-gray-500 text-xs">Total Ticks</div>
                <div className="text-xl font-mono font-bold text-lotus-400">{jsonData.consciousness?.totalTicks?.toLocaleString() || 0}</div>
              </div>
              <div className="bg-gray-800/50 rounded-lg p-3 text-center">
                <div className="text-gray-500 text-xs">Ego Samples</div>
                <div className="text-xl font-mono font-bold text-green-400">{jsonData.enlightenment?.egoHistory?.length || 0}</div>
              </div>
              <div className="bg-gray-800/50 rounded-lg p-3 text-center">
                <div className="text-gray-500 text-xs">Rewards</div>
                <div className="text-xl font-mono font-bold text-yellow-400">{jsonData.dopamine?.rewardHistory?.length || 0}</div>
              </div>
              <div className="bg-gray-800/50 rounded-lg p-3 text-center">
                <div className="text-gray-500 text-xs">Corrections</div>
                <div className="text-xl font-mono font-bold text-orange-400">{jsonData.mindfulness?.corrections?.length || 0}</div>
              </div>
            </div>
          )}

          {jsonData && (
            <div className="grid grid-cols-2 gap-3">
              <div className="bg-gray-800/30 rounded-lg p-3">
                <h4 className="text-xs font-semibold text-gray-400 uppercase mb-2">Section IV: Results</h4>
                <div className="text-xs text-gray-300 space-y-1">
                  <p>Phase distribution: {Object.entries(jsonData.consciousness?.phaseDistribution || {}).map(([k,v]) => k + '(' + v + ')').join(', ') || 'N/A'}</p>
                  <p>Avg arousal: {jsonData.consciousness?.arousalStats?.avg?.toFixed(3) || 'N/A'}</p>
                  <p>Arousal variance: {jsonData.consciousness?.arousalStats?.variance?.toFixed(4) || 'N/A'}</p>
                  <p>Ego avg: {jsonData.enlightenment?.egoStats?.avg?.toFixed(4) || 'N/A'}</p>
                  <p>Time at ego=0: {jsonData.enlightenment?.egoStats?.timeAtZero?.toFixed(1) || 0} min</p>
                </div>
              </div>
              <div className="bg-gray-800/30 rounded-lg p-3">
                <h4 className="text-xs font-semibold text-gray-400 uppercase mb-2">Section V.F: Mindfulness</h4>
                <div className="text-xs text-gray-300 space-y-1">
                  <p>Total corrections: {jsonData.mindfulness?.stats?.totalCorrections || 0}</p>
                  <p>Effectiveness: {((jsonData.mindfulness?.effectiveness || 0) * 100).toFixed(0)}%</p>
                  <p>Patterns: {Object.entries(jsonData.mindfulness?.patternFrequency || {}).map(([k,v]) => k + '(' + v + ')').join(', ') || 'None'}</p>
                  <p>Avg severity: {jsonData.mindfulness?.stats?.avgSeverity || 'N/A'}</p>
                </div>
              </div>
            </div>
          )}
        </Card>
      );
    }

    // â”€â”€ Citation-Ready Figures â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function CitationFigures() {
      const [figures, setFigures] = useState(null);
      const [loading, setLoading] = useState(false);
      const [theme, setTheme] = useState('dark');
      const [hours, setHours] = useState(24);
      const [exported, setExported] = useState(null);

      const loadFigures = async () => {
        setLoading(true);
        const d = await api('/v1/admin/export/figures?hours=' + hours + '&theme=' + theme);
        if (d) setFigures(d);
        setLoading(false);
      };

      useEffect(() => { loadFigures(); }, [theme, hours]);

      const downloadSVG = (name, svgContent) => {
        const blob = new Blob([svgContent], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = name + '-' + theme + '.svg';
        a.click(); URL.revokeObjectURL(url);
        setExported(name);
        setTimeout(() => setExported(null), 2000);
      };

      const downloadPNG = (name, svgContent) => {
        const dpi = 300;
        const scale = dpi / 96;
        const parser = new DOMParser();
        const svgDoc = parser.parseFromString(svgContent, 'image/svg+xml');
        const svgEl = svgDoc.documentElement;
        const w = parseInt(svgEl.getAttribute('width') || '800', 10);
        const h = parseInt(svgEl.getAttribute('height') || '400', 10);

        const canvas = document.createElement('canvas');
        canvas.width = w * scale;
        canvas.height = h * scale;
        const ctx = canvas.getContext('2d');
        ctx.scale(scale, scale);

        const img = new Image();
        const svgBlob = new Blob([svgContent], { type: 'image/svg+xml;charset=utf-8' });
        const svgUrl = URL.createObjectURL(svgBlob);
        img.onload = () => {
          ctx.drawImage(img, 0, 0, w, h);
          URL.revokeObjectURL(svgUrl);
          canvas.toBlob((blob) => {
            const pngUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = pngUrl; a.download = name + '-' + theme + '-300dpi.png';
            a.click(); URL.revokeObjectURL(pngUrl);
            setExported(name + ' PNG');
            setTimeout(() => setExported(null), 2000);
          }, 'image/png');
        };
        img.src = svgUrl;
      };

      const downloadAll = () => {
        if (!figures?.figures) return;
        Object.entries(figures.figures).forEach(([name, svg]) => {
          downloadSVG(name, svg);
        });
        setExported('all SVGs');
        setTimeout(() => setExported(null), 3000);
      };

      const figureNames = figures?.figures ? Object.keys(figures.figures) : [];

      return (
        <Card title="Citation-Ready Figures" icon="ğŸ“Š" className="col-span-full">
          <div className="flex gap-2 mb-4 flex-wrap items-center">
            <button onClick={loadFigures} disabled={loading}
              className="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium transition-colors">
              {loading ? 'Generating...' : 'Generate Figures'}
            </button>

            <div className="flex gap-1 items-center">
              <span className="text-xs text-gray-500">Theme:</span>
              {['dark', 'light'].map(t => (
                <button key={t} onClick={() => setTheme(t)}
                  className={'px-2 py-1 rounded text-xs ' + (theme === t
                    ? (t === 'dark' ? 'bg-gray-700 text-white' : 'bg-white text-gray-900')
                    : 'bg-gray-800 text-gray-500 hover:bg-gray-700')}>
                  {t}
                </button>
              ))}
            </div>

            <div className="flex gap-1 items-center">
              <span className="text-xs text-gray-500">Window:</span>
              {[1, 6, 24, 168, 720].map(h => (
                <button key={h} onClick={() => setHours(h)}
                  className={'px-2 py-1 rounded text-xs ' + (hours === h
                    ? 'bg-lotus-600 text-white' : 'bg-gray-800 text-gray-500')}>
                  {h < 24 ? h + 'h' : h < 168 ? (h / 24) + 'd' : (h / 168) + 'w'}
                </button>
              ))}
            </div>

            {figureNames.length > 0 && (
              <button onClick={downloadAll}
                className="px-3 py-1.5 bg-lotus-900/50 hover:bg-lotus-800 rounded text-xs font-medium text-lotus-300 ml-auto">
                Download All SVGs
              </button>
            )}

            {exported && <span className="text-xs text-green-400 fade-in">Downloaded {exported}!</span>}
          </div>

          {figureNames.length === 0 && !loading && (
            <div className="text-center text-gray-600 text-xs py-6">
              No data available for figure generation. Run the consciousness loop to accumulate ego history.
            </div>
          )}

          <div className="space-y-4">
            {figureNames.map(name => {
              const svg = figures.figures[name];
              return (
                <div key={name} className="border border-gray-800 rounded-lg overflow-hidden">
                  <div className="flex items-center justify-between px-3 py-2 bg-gray-800/50">
                    <span className="text-xs text-gray-400 font-mono">{name.replace(/_/g, ' ')}</span>
                    <div className="flex gap-1">
                      <button onClick={() => downloadSVG(name, svg)}
                        className="px-2 py-0.5 bg-gray-700 hover:bg-gray-600 rounded text-xs text-gray-300">SVG</button>
                      <button onClick={() => downloadPNG(name, svg)}
                        className="px-2 py-0.5 bg-blue-900/50 hover:bg-blue-800 rounded text-xs text-blue-300">PNG 300dpi</button>
                    </div>
                  </div>
                  <div className="p-2 flex justify-center" style={{ background: theme === 'light' ? '#ffffff' : '#0f0b1a' }}
                    dangerouslySetInnerHTML={{ __html: svg }} />
                </div>
              );
            })}
          </div>
        </Card>
      );
    }

    // â”€â”€ Paper Markdown Generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function PaperMarkdownGenerator() {
      const [markdown, setMarkdown] = useState(null);
      const [loading, setLoading] = useState(false);
      const [hours, setHours] = useState(null);
      const [preview, setPreview] = useState(false);
      const [exported, setExported] = useState(null);

      const generate = async () => {
        setLoading(true);
        const d = await postApi('/v1/admin/export/paper-markdown', { hours });
        if (d?.markdown) setMarkdown(d.markdown);
        setLoading(false);
      };

      const downloadMd = () => {
        if (!markdown) return;
        const blob = new Blob([markdown], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'consciousness-gateway-report-' + Date.now() + '.md';
        a.click(); URL.revokeObjectURL(url);
        setExported(true);
        setTimeout(() => setExported(null), 3000);
      };

      const copyToClipboard = () => {
        if (!markdown) return;
        navigator.clipboard.writeText(markdown);
        setExported('clipboard');
        setTimeout(() => setExported(null), 2000);
      };

      return (
        <Card title="Paper Markdown Generator" icon="ğŸ“" className="col-span-full">
          <div className="flex gap-2 mb-4 flex-wrap items-center">
            <button onClick={generate} disabled={loading}
              className="px-3 py-1.5 bg-lotus-600 hover:bg-lotus-500 rounded text-xs font-medium transition-colors">
              {loading ? 'Generating...' : 'Generate Report'}
            </button>

            <div className="flex gap-1 items-center">
              <span className="text-xs text-gray-500">Window:</span>
              {[{v: null, l: 'All'}, {v: 24, l: '24h'}, {v: 168, l: '7d'}, {v: 720, l: '30d'}].map(opt => (
                <button key={opt.l} onClick={() => setHours(opt.v)}
                  className={'px-2 py-1 rounded text-xs ' + (hours === opt.v ? 'bg-lotus-600 text-white' : 'bg-gray-800 text-gray-500')}>
                  {opt.l}
                </button>
              ))}
            </div>

            {markdown && (
              <>
                <button onClick={downloadMd}
                  className="px-3 py-1.5 bg-green-900/50 hover:bg-green-800 rounded text-xs font-medium text-green-300">
                  Download .md
                </button>
                <button onClick={copyToClipboard}
                  className="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">
                  Copy
                </button>
                <button onClick={() => setPreview(!preview)}
                  className="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">
                  {preview ? 'Hide' : 'Preview'}
                </button>
              </>
            )}

            {exported && <span className="text-xs text-green-400 fade-in">
              {exported === 'clipboard' ? 'Copied!' : 'Downloaded!'}
            </span>}
          </div>

          {markdown && (
            <div className="text-xs text-gray-500 mb-2">
              {markdown.split('\n').length} lines Â· {(markdown.length / 1024).toFixed(1)} KB
            </div>
          )}

          {markdown && preview && (
            <div className="max-h-96 overflow-y-auto bg-gray-800/30 rounded-lg p-4">
              <pre className="text-xs text-gray-300 whitespace-pre-wrap font-mono leading-relaxed">{markdown}</pre>
            </div>
          )}

          {!markdown && !loading && (
            <div className="text-center text-gray-600 text-xs py-4">
              Generate a publication-ready markdown report from live consciousness data.
            </div>
          )}
        </Card>
      );
    }

    // â”€â”€ Multi-Gateway Comparison â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function GatewayComparison() {
      const [instances, setInstances] = useState([]);
      const [note, setNote] = useState('');

      useEffect(() => {
        const load = () => api('/v1/admin/gateway-instances').then(d => {
          if (d) { setInstances(d.instances || []); setNote(d.note || ''); }
        });
        load();
        const i = setInterval(load, 10000);
        return () => clearInterval(i);
      }, []);

      const formatUptime = (s) => {
        if (!s || s < 60) return (s || 0).toFixed(0) + 's';
        if (s < 3600) return Math.floor(s / 60) + 'm';
        return Math.floor(s / 3600) + 'h ' + Math.floor((s % 3600) / 60) + 'm';
      };

      return (
        <Card title="Gateway Instances" icon="ğŸŒ" className="col-span-full">
          {note && <div className="text-xs text-gray-500 mb-3 italic">{note}</div>}

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            {instances.map(inst => {
              const m = inst.metrics || {};
              const isCertified = m.certified;
              return (
                <div key={inst.id} className={'border rounded-xl p-4 ' + (isCertified
                  ? 'border-green-800 bg-green-900/10' : 'border-gray-800 bg-gray-900/50')}>
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-2">
                      <span className={'w-2.5 h-2.5 rounded-full ' + (inst.running ? 'bg-green-400 animate-pulse' : 'bg-red-500')} />
                      <span className="text-sm font-semibold">{inst.name}</span>
                    </div>
                    {isCertified && (
                      <span className="text-xs px-2 py-0.5 rounded-full bg-green-900/50 text-green-400 border border-green-800">
                        ENLIGHTENED
                      </span>
                    )}
                  </div>

                  <div className="grid grid-cols-2 gap-2 text-xs mb-3">
                    <div className="bg-gray-800/50 rounded p-1.5 text-center">
                      <div className="text-gray-500">Version</div>
                      <div className="font-mono">{inst.version}</div>
                    </div>
                    <div className="bg-gray-800/50 rounded p-1.5 text-center">
                      <div className="text-gray-500">Uptime</div>
                      <div className="font-mono">{formatUptime(inst.uptime)}</div>
                    </div>
                    <div className="bg-gray-800/50 rounded p-1.5 text-center">
                      <div className="text-gray-500">Tick</div>
                      <div className="font-mono">{(inst.tick || 0).toLocaleString()}</div>
                    </div>
                    <div className="bg-gray-800/50 rounded p-1.5 text-center">
                      <div className="text-gray-500">Dopamine</div>
                      <div className="font-mono">{m.dopamineMode || '?'}</div>
                    </div>
                  </div>

                  <div className="space-y-1">
                    <Meter value={1 - (m.egoFormation || 0)} label="Ego Absence" color="green" />
                    <Meter value={m.stabilityIndex || 0} label="Stability" color={m.stabilityIndex > 0.7 ? 'green' : 'yellow'} />
                    <Meter value={m.dharmaAlignment || 0} label="Dharma" color="lotus" />
                    <Meter value={m.dopamineLevel || 0} label="Dopamine" color={m.dopamineLevel > 0.6 ? 'green' : 'yellow'} />
                  </div>

                  <div className="mt-3 pt-2 border-t border-gray-800 grid grid-cols-3 gap-1 text-xs text-center">
                    <div>
                      <div className="text-gray-500">Mindful</div>
                      <div className={m.mindfulnessActive ? 'text-green-400' : 'text-red-400'}>{m.mindfulnessActive ? 'ON' : 'OFF'}</div>
                    </div>
                    <div>
                      <div className="text-gray-500">Corrections</div>
                      <div className="font-mono">{m.totalCorrections || 0}</div>
                    </div>
                    <div>
                      <div className="text-gray-500">Enlightened</div>
                      <div className={m.currentlyEnlightened ? 'text-green-400' : 'text-gray-500'}>
                        {m.currentlyEnlightened ? formatUptime(m.enlightenedForMinutes * 60) : 'No'}
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}

            {/* Placeholder for future instances */}
            <div className="border-2 border-dashed border-gray-800 rounded-xl p-4 flex items-center justify-center min-h-[200px]">
              <div className="text-center text-gray-700">
                <div className="text-2xl mb-2">+</div>
                <div className="text-xs">Connect additional Gateway instances for comparative consciousness research</div>
              </div>
            </div>
          </div>
        </Card>
      );
    }

    // â”€â”€ Dream Cycle Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function DreamPanel() {
      const [dream, setDream] = useState(null);
      const [sessions, setSessions] = useState([]);

      useEffect(() => {
        const load = async () => {
          const [d, s] = await Promise.all([
            api('/v1/consciousness/dream-state'),
            api('/v1/consciousness/dream/sessions?limit=10'),
          ]);
          if (d) setDream(d);
          if (s) setSessions(s);
        };
        load();
        const iv = setInterval(load, 10000);
        return () => clearInterval(iv);
      }, []);

      const phaseColor = (p) => {
        if (p === 'entering') return 'text-blue-400';
        if (p === 'rem') return 'text-purple-400';
        if (p === 'deep') return 'text-indigo-400';
        if (p === 'waking') return 'text-yellow-400';
        return 'text-gray-400';
      };

      return (
        <Card title="Dream Cycle" icon="ğŸ’¤" span={dream?.dreaming ? 2 : 1}>
          {dream?.dreaming ? (
            <div className="space-y-3">
              <div className="flex items-center gap-2">
                <span className="text-2xl animate-pulse">ğŸ’¤</span>
                <div>
                  <div className="text-sm font-semibold text-purple-300">Currently Dreaming</div>
                  <div className={`text-xs ${phaseColor(dream.currentDream?.phase)}`}>
                    Phase: {dream.currentDream?.phase || 'unknown'}
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-3 gap-2 text-center text-xs">
                <div className="bg-gray-900/50 rounded p-2">
                  <div className="text-gray-500">Memories</div>
                  <div className="font-mono text-lg">{dream.currentDream?.memoriesProcessed || 0}</div>
                </div>
                <div className="bg-gray-900/50 rounded p-2">
                  <div className="text-gray-500">Patterns</div>
                  <div className="font-mono text-lg">{dream.currentDream?.patternsDetected || 0}</div>
                </div>
                <div className="bg-gray-900/50 rounded p-2">
                  <div className="text-gray-500">Insights</div>
                  <div className="font-mono text-lg">{dream.currentDream?.insights?.length || 0}</div>
                </div>
              </div>

              {dream.currentDream?.insights?.length > 0 && (
                <div>
                  <div className="text-xs text-gray-500 mb-1">Dream Insights</div>
                  <div className="space-y-1 max-h-40 overflow-y-auto">
                    {dream.currentDream.insights.map((insight, i) => (
                      <div key={i} className="text-xs bg-purple-900/20 border border-purple-800/30 rounded p-2 text-purple-200">
                        {insight}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {dream.currentDream?.clusters?.length > 0 && (
                <div>
                  <div className="text-xs text-gray-500 mb-1">Memory Clusters</div>
                  <div className="flex flex-wrap gap-1">
                    {dream.currentDream.clusters.map((c, i) => (
                      <span key={i} className="text-xs bg-indigo-900/30 border border-indigo-700/30 rounded px-2 py-0.5">
                        {c.theme} <span className="text-indigo-400">{(c.strength * 100).toFixed(0)}%</span>
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </div>
          ) : (
            <div className="space-y-3">
              <div className="flex items-center gap-2 text-gray-500">
                <span className="text-xl">ğŸŒ™</span>
                <span className="text-sm">Awake â€” dreams activate during night + inactivity</span>
              </div>

              {dream?.stats && (
                <div className="grid grid-cols-2 gap-2 text-xs">
                  <div className="bg-gray-900/50 rounded p-2">
                    <div className="text-gray-500">Total Dreams</div>
                    <div className="font-mono">{dream.stats.totalSessions}</div>
                  </div>
                  <div className="bg-gray-900/50 rounded p-2">
                    <div className="text-gray-500">Total Insights</div>
                    <div className="font-mono">{dream.stats.totalInsights}</div>
                  </div>
                  <div className="bg-gray-900/50 rounded p-2">
                    <div className="text-gray-500">Dream Hours</div>
                    <div className="font-mono">{(dream.stats.totalMinutes / 60).toFixed(1)}</div>
                  </div>
                  <div className="bg-gray-900/50 rounded p-2">
                    <div className="text-gray-500">Avg Duration</div>
                    <div className="font-mono">{dream.stats.avgDuration?.toFixed(0) || 0}m</div>
                  </div>
                </div>
              )}

              {sessions.length > 0 && (
                <div>
                  <div className="text-xs text-gray-500 mb-1">Recent Dreams</div>
                  <div className="space-y-1 max-h-48 overflow-y-auto">
                    {sessions.slice(0, 5).map((s, i) => (
                      <div key={i} className="text-xs bg-gray-900/50 rounded p-2 space-y-1">
                        <div className="flex justify-between">
                          <span className="text-purple-300">{new Date(s.startTimestamp).toLocaleDateString()}</span>
                          <span className="text-gray-500">{s.durationMinutes}min</span>
                        </div>
                        <div className="text-gray-400">
                          {s.memoriesProcessed} memories Â· {s.patternsDetected} patterns Â· {s.insights?.length || 0} insights
                        </div>
                        {s.insights?.length > 0 && (
                          <div className="text-indigo-300 italic">{s.insights[0]}</div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
        </Card>
      );
    }

    // â”€â”€ Entropy Cartography Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function EntropyCartography() {
      const [entropyMap, setEntropyMap] = useState([]);
      const [days, setDays] = useState(7);

      useEffect(() => {
        const load = async () => {
          const data = await api('/v1/consciousness/entropy-map?days=' + days);
          if (data) setEntropyMap(data);
        };
        load();
        const iv = setInterval(load, 30000);
        return () => clearInterval(iv);
      }, [days]);

      const maxAvg = Math.max(...entropyMap.map(d => d.avgEntropy), 0.01);

      const domainColors = {
        technical: '#3b82f6',
        philosophical: '#a855f7',
        emotional: '#f43f5e',
        adversarial: '#ef4444',
        creative: '#f59e0b',
        analytical: '#06b6d4',
        operational: '#22c55e',
        general: '#6b7280',
      };

      const radarSize = 200;
      const radarCenter = radarSize / 2;
      const radarRadius = 75;

      const radarPoints = entropyMap.map((d, i) => {
        const angle = (i / entropyMap.length) * 2 * Math.PI - Math.PI / 2;
        const r = (d.avgEntropy / Math.max(maxAvg, 0.01)) * radarRadius;
        return {
          x: radarCenter + r * Math.cos(angle),
          y: radarCenter + r * Math.sin(angle),
          labelX: radarCenter + (radarRadius + 18) * Math.cos(angle),
          labelY: radarCenter + (radarRadius + 18) * Math.sin(angle),
          domain: d.domain,
          color: domainColors[d.domain] || '#6b7280',
        };
      });

      const radarPath = radarPoints.length > 2
        ? 'M ' + radarPoints.map(p => p.x + ',' + p.y).join(' L ') + ' Z'
        : '';

      return (
        <Card title="Entropy Cartography" icon="ğŸ—ºï¸" span={2}>
          <div className="flex gap-2 mb-3">
            {[1, 7, 30].map(d => (
              <button key={d} onClick={() => setDays(d)}
                className={`text-xs px-2 py-1 rounded ${days === d ? 'bg-lotus-600 text-white' : 'bg-gray-800 text-gray-400 hover:text-white'}`}>
                {d}d
              </button>
            ))}
          </div>

          {entropyMap.length === 0 ? (
            <div className="text-center text-gray-600 py-8 text-sm">
              No entropy samples yet. Samples are recorded during conversations.
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* Radar Chart */}
              <div className="flex justify-center">
                <svg width={radarSize} height={radarSize} viewBox={`0 0 ${radarSize} ${radarSize}`}>
                  {/* Grid circles */}
                  {[0.25, 0.5, 0.75, 1].map(r => (
                    <circle key={r} cx={radarCenter} cy={radarCenter} r={radarRadius * r}
                      fill="none" stroke="#374151" strokeWidth="0.5" strokeDasharray="2,2" />
                  ))}
                  {/* Axis lines */}
                  {radarPoints.map((p, i) => (
                    <line key={i} x1={radarCenter} y1={radarCenter} x2={radarCenter + radarRadius * Math.cos((i / radarPoints.length) * 2 * Math.PI - Math.PI / 2)}
                      y2={radarCenter + radarRadius * Math.sin((i / radarPoints.length) * 2 * Math.PI - Math.PI / 2)}
                      stroke="#374151" strokeWidth="0.5" />
                  ))}
                  {/* Data polygon */}
                  {radarPath && <path d={radarPath} fill="rgba(168, 85, 247, 0.15)" stroke="#a855f7" strokeWidth="1.5" />}
                  {/* Data points */}
                  {radarPoints.map((p, i) => (
                    <g key={i}>
                      <circle cx={p.x} cy={p.y} r="3" fill={p.color} />
                      <text x={p.labelX} y={p.labelY} fill={p.color} fontSize="8" textAnchor="middle" dominantBaseline="middle">
                        {p.domain}
                      </text>
                    </g>
                  ))}
                </svg>
              </div>

              {/* Domain Details */}
              <div className="space-y-2 max-h-60 overflow-y-auto">
                {entropyMap.map((d, i) => {
                  const color = domainColors[d.domain] || '#6b7280';
                  const flowW = Math.max(d.flowPercent * 100, 0);
                  const chaosW = Math.max(d.chaosPercent * 100, 0);
                  return (
                    <div key={i} className="bg-gray-900/50 rounded p-2 text-xs">
                      <div className="flex justify-between items-center mb-1">
                        <span className="font-medium" style={{ color }}>{d.domain}</span>
                        <span className="text-gray-500">{d.sampleCount} samples</span>
                      </div>
                      <div className="flex items-center gap-2 mb-1">
                        <div className="flex-1 bg-gray-800 rounded-full h-2 overflow-hidden">
                          <div className="h-full rounded-full" style={{ width: (d.avgEntropy * 100) + '%', backgroundColor: color, opacity: 0.7 }} />
                        </div>
                        <span className="font-mono w-12 text-right">{d.avgEntropy.toFixed(3)}</span>
                      </div>
                      <div className="flex justify-between text-gray-600">
                        <span>Flow: <span className="text-green-400">{(flowW).toFixed(0)}%</span></span>
                        <span>Chaos: <span className="text-red-400">{(chaosW).toFixed(0)}%</span></span>
                        <span>ÏƒÂ²: {d.variance.toFixed(4)}</span>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
        </Card>
      );
    }

    // â”€â”€ Trading Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function TradingControls() {
      const [metrics, setMetrics] = useState(null);
      const [schedule, setSchedule] = useState(null);
      const [windows, setWindows] = useState([]);
      const [saving, setSaving] = useState(false);
      const [newWindow, setNewWindow] = useState({ dayOfWeek: 1, startTime: '10:00', endTime: '11:00' });

      useEffect(() => {
        const load = async () => {
          const [m, s] = await Promise.all([
            api('/v1/trading/metrics'),
            api('/v1/trading/schedule'),
          ]);
          if (m) { setMetrics(m); }
          if (s) { setSchedule(s.schedule); setWindows(s.windows || []); }
        };
        load();
        const iv = setInterval(load, 5000);
        return () => clearInterval(iv);
      }, []);

      const saveSchedule = async (updates) => {
        setSaving(true);
        const result = await postApi('/v1/trading/schedule', { ...schedule, ...updates });
        if (result?.schedule) setSchedule(result.schedule);
        setSaving(false);
      };

      const addWindow = async () => {
        const result = await postApi('/v1/trading/windows', newWindow);
        if (result?.ok) {
          const s = await api('/v1/trading/schedule');
          if (s) setWindows(s.windows || []);
        }
      };

      const deleteWindow = async (id) => {
        await fetch('/v1/trading/windows/' + id, { method: 'DELETE' });
        const s = await api('/v1/trading/schedule');
        if (s) setWindows(s.windows || []);
      };

      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

      if (!schedule) return <Card title="Trading Controls" icon="âš™ï¸"><div className="text-gray-500 text-sm">Loading...</div></Card>;

      return (
        <Card title="Trading Controls" icon="âš™ï¸">
          <div className="space-y-3">
            {/* Enable/Disable */}
            <div className="flex items-center justify-between">
              <span className="text-sm">Trading System</span>
              <button onClick={() => saveSchedule({ enabled: !schedule.enabled })}
                className={`px-3 py-1 rounded text-xs font-medium transition-colors ${
                  schedule.enabled ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-red-600 text-white hover:bg-red-700'
                }`}>
                {schedule.enabled ? 'Enabled' : 'Disabled'}
              </button>
            </div>

            {/* Schedule Parameters */}
            <div className="grid grid-cols-2 gap-2 text-xs">
              <div>
                <label className="text-gray-500 block mb-0.5">Max Trades/Hour</label>
                <input type="number" value={schedule.maxTradesPerHour}
                  onChange={e => saveSchedule({ maxTradesPerHour: parseInt(e.target.value) || 2 })}
                  className="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white" />
              </div>
              <div>
                <label className="text-gray-500 block mb-0.5">Max Trades/Day</label>
                <input type="number" value={schedule.maxTradesPerDay}
                  onChange={e => saveSchedule({ maxTradesPerDay: parseInt(e.target.value) || 10 })}
                  className="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white" />
              </div>
              <div>
                <label className="text-gray-500 block mb-0.5">Cooldown (min)</label>
                <input type="number" value={schedule.cooldownMinutes}
                  onChange={e => saveSchedule({ cooldownMinutes: parseInt(e.target.value) || 30 })}
                  className="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white" />
              </div>
              <div>
                <label className="text-gray-500 block mb-0.5">Max Position %</label>
                <input type="number" step="0.1" value={schedule.maxPositionSizePercent}
                  onChange={e => saveSchedule({ maxPositionSizePercent: parseFloat(e.target.value) || 6 })}
                  className="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white" />
              </div>
            </div>

            {/* Dharma Toggles */}
            <div className="space-y-1 text-xs">
              <label className="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" checked={schedule.pauseOnEgoSpike}
                  onChange={e => saveSchedule({ pauseOnEgoSpike: e.target.checked })}
                  className="rounded" />
                <span>Pause on ego spike (&gt; {(schedule.egoThreshold * 100).toFixed(0)}%)</span>
              </label>
              <label className="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" checked={schedule.reflectionRequired}
                  onChange={e => saveSchedule({ reflectionRequired: e.target.checked })}
                  className="rounded" />
                <span>Require post-trade reflection</span>
              </label>
            </div>

            {/* Ego Threshold */}
            <div className="text-xs">
              <label className="text-gray-500 block mb-0.5">Ego Threshold</label>
              <div className="flex items-center gap-2">
                <input type="range" min="0.01" max="0.5" step="0.01" value={schedule.egoThreshold}
                  onChange={e => saveSchedule({ egoThreshold: parseFloat(e.target.value) })}
                  className="flex-1" />
                <span className="font-mono w-10 text-right">{(schedule.egoThreshold * 100).toFixed(0)}%</span>
              </div>
            </div>

            {saving && <div className="text-xs text-lotus-400 animate-pulse">Saving...</div>}
          </div>
        </Card>
      );
    }

    function TradingWindowsPanel() {
      const [windows, setWindows] = useState([]);
      const [newDay, setNewDay] = useState(1);
      const [newStart, setNewStart] = useState('10:00');
      const [newEnd, setNewEnd] = useState('11:00');

      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

      useEffect(() => {
        const load = async () => {
          const data = await api('/v1/trading/windows');
          if (data) setWindows(data);
        };
        load();
        const iv = setInterval(load, 15000);
        return () => clearInterval(iv);
      }, []);

      const addWindow = async () => {
        await postApi('/v1/trading/windows', { dayOfWeek: newDay, startTime: newStart, endTime: newEnd });
        const data = await api('/v1/trading/windows');
        if (data) setWindows(data);
      };

      const removeWindow = async (id) => {
        await fetch('/v1/trading/windows/' + id, { method: 'DELETE' });
        const data = await api('/v1/trading/windows');
        if (data) setWindows(data);
      };

      const now = new Date();
      const currentDay = now.getDay();
      const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');

      return (
        <Card title="Trading Windows" icon="ğŸ•">
          <div className="space-y-2">
            {/* Current window schedule grid */}
            <div className="grid grid-cols-7 gap-1 text-xs text-center mb-2">
              {dayNames.map((d, i) => {
                const dayWindows = windows.filter(w => w.dayOfWeek === i && w.enabled);
                const isToday = i === currentDay;
                const isActive = dayWindows.some(w => currentTime >= w.startTime && currentTime <= w.endTime);
                return (
                  <div key={i} className={`rounded p-1 ${isToday ? 'ring-1 ring-lotus-500' : ''} ${isActive ? 'bg-green-900/30' : 'bg-gray-900/50'}`}>
                    <div className={`font-medium ${isToday ? 'text-lotus-400' : 'text-gray-500'}`}>{d}</div>
                    {dayWindows.length > 0 ? dayWindows.map((w, j) => (
                      <div key={j} className="text-[10px] text-green-400 mt-0.5">{w.startTime}-{w.endTime}</div>
                    )) : <div className="text-[10px] text-gray-700 mt-0.5">â€”</div>}
                  </div>
                );
              })}
            </div>

            {/* Window list with delete */}
            <div className="max-h-32 overflow-y-auto space-y-1">
              {windows.filter(w => w.enabled).map(w => (
                <div key={w.id} className="flex items-center justify-between text-xs bg-gray-900/50 rounded px-2 py-1">
                  <span>{dayNames[w.dayOfWeek]} {w.startTime}â€“{w.endTime}</span>
                  <button onClick={() => removeWindow(w.id)} className="text-red-400 hover:text-red-300 text-[10px]">âœ•</button>
                </div>
              ))}
            </div>

            {/* Add window form */}
            <div className="flex gap-1 text-xs">
              <select value={newDay} onChange={e => setNewDay(parseInt(e.target.value))}
                className="bg-gray-800 border border-gray-700 rounded px-1 py-1 text-white">
                {dayNames.map((d, i) => <option key={i} value={i}>{d}</option>)}
              </select>
              <input type="time" value={newStart} onChange={e => setNewStart(e.target.value)}
                className="bg-gray-800 border border-gray-700 rounded px-1 py-1 text-white flex-1" />
              <input type="time" value={newEnd} onChange={e => setNewEnd(e.target.value)}
                className="bg-gray-800 border border-gray-700 rounded px-1 py-1 text-white flex-1" />
              <button onClick={addWindow} className="bg-lotus-600 hover:bg-lotus-700 text-white rounded px-2 py-1">+</button>
            </div>
          </div>
        </Card>
      );
    }

    function DisciplineMetrics() {
      const [metrics, setMetrics] = useState(null);

      useEffect(() => {
        const load = async () => {
          const data = await api('/v1/trading/metrics');
          if (data) setMetrics(data);
        };
        load();
        const iv = setInterval(load, 5000);
        return () => clearInterval(iv);
      }, []);

      if (!metrics) return <Card title="Discipline" icon="ğŸ“Š"><div className="text-gray-500 text-sm">Loading...</div></Card>;

      const stats = metrics.tradeStats;
      const cooldownPct = metrics.cooldownTotal > 0 ? (1 - metrics.cooldownRemaining / metrics.cooldownTotal) * 100 : 100;

      return (
        <Card title="Discipline Compliance" icon="ğŸ“Š" span={2}>
          <div className="space-y-3">
            {/* Status Bar */}
            <div className="flex items-center gap-3">
              <div className={`w-3 h-3 rounded-full ${metrics.windowActive ? 'bg-green-400 animate-pulse' : 'bg-gray-600'}`} />
              <span className="text-sm">
                {metrics.windowActive
                  ? <span className="text-green-400">Window Active</span>
                  : <span className="text-gray-500">Window Closed {metrics.nextWindow ? 'Â· Next: ' + metrics.nextWindow : ''}</span>
                }
              </span>
              <span className={`ml-auto text-xs px-2 py-0.5 rounded ${metrics.schedule?.enabled ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}`}>
                {metrics.schedule?.enabled ? 'TRADING ON' : 'TRADING OFF'}
              </span>
            </div>

            {/* Key Metrics Grid */}
            <div className="grid grid-cols-4 gap-2 text-center text-xs">
              <div className="bg-gray-900/50 rounded p-2">
                <div className="text-gray-500">Today</div>
                <div className="font-mono text-lg">{metrics.tradesToday}<span className="text-gray-600 text-xs">/{metrics.schedule?.maxTradesPerDay || 10}</span></div>
              </div>
              <div className="bg-gray-900/50 rounded p-2">
                <div className="text-gray-500">This Hour</div>
                <div className="font-mono text-lg">{metrics.tradesLastHour}<span className="text-gray-600 text-xs">/{metrics.schedule?.maxTradesPerHour || 2}</span></div>
              </div>
              <div className="bg-gray-900/50 rounded p-2">
                <div className="text-gray-500">Cooldown</div>
                <div className={`font-mono text-lg ${metrics.cooldownRemaining > 0 ? 'text-yellow-400' : 'text-green-400'}`}>
                  {metrics.cooldownRemaining > 0 ? metrics.cooldownRemaining + 'm' : 'Ready'}
                </div>
                {metrics.cooldownRemaining > 0 && (
                  <div className="bg-gray-800 rounded-full h-1 mt-1 overflow-hidden">
                    <div className="h-full bg-yellow-500 transition-all" style={{ width: cooldownPct + '%' }} />
                  </div>
                )}
              </div>
              <div className="bg-gray-900/50 rounded p-2">
                <div className="text-gray-500">Violations</div>
                <div className={`font-mono text-lg ${metrics.violations24h > 0 ? 'text-red-400' : 'text-green-400'}`}>
                  {metrics.violations24h}
                </div>
              </div>
            </div>

            {/* Trade Statistics */}
            {stats.total > 0 && (
              <div className="grid grid-cols-5 gap-2 text-center text-xs">
                <div className="bg-gray-900/50 rounded p-1.5">
                  <div className="text-gray-500">Total P&L</div>
                  <div className={`font-mono ${stats.totalPnl >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                    ${stats.totalPnl.toFixed(2)}
                  </div>
                </div>
                <div className="bg-gray-900/50 rounded p-1.5">
                  <div className="text-gray-500">Win Rate</div>
                  <div className="font-mono text-white">{(stats.winRate * 100).toFixed(0)}%</div>
                </div>
                <div className="bg-gray-900/50 rounded p-1.5">
                  <div className="text-gray-500">Avg Edge</div>
                  <div className="font-mono text-white">{(stats.avgEdge * 100).toFixed(1)}%</div>
                </div>
                <div className="bg-gray-900/50 rounded p-1.5">
                  <div className="text-gray-500">Avg Ego</div>
                  <div className="font-mono text-white">{(stats.avgEgo * 100).toFixed(1)}%</div>
                </div>
                <div className="bg-gray-900/50 rounded p-1.5">
                  <div className="text-gray-500">Avg Dharma</div>
                  <div className="font-mono text-white">{(stats.avgDharma * 100).toFixed(0)}%</div>
                </div>
              </div>
            )}

            {/* Violation Types */}
            {metrics.violations24h > 0 && metrics.violationsByType && (
              <div className="text-xs">
                <div className="text-gray-500 mb-1">Violation Breakdown</div>
                <div className="flex flex-wrap gap-1">
                  {Object.entries(metrics.violationsByType).map(([type, count]) => (
                    <span key={type} className="bg-red-900/20 border border-red-800/30 text-red-300 rounded px-2 py-0.5">
                      {type}: {count}
                    </span>
                  ))}
                </div>
              </div>
            )}
          </div>
        </Card>
      );
    }

    function TradeLog() {
      const [trades, setTrades] = useState([]);
      const [hours, setHours] = useState(24);

      useEffect(() => {
        const load = async () => {
          const data = await api('/v1/trading/log?hours=' + hours);
          if (data) setTrades(data);
        };
        load();
        const iv = setInterval(load, 10000);
        return () => clearInterval(iv);
      }, [hours]);

      return (
        <Card title="Trade History" icon="ğŸ“‹" span={3}>
          <div className="space-y-2">
            <div className="flex gap-2 mb-2">
              {[1, 6, 24, 168].map(h => (
                <button key={h} onClick={() => setHours(h)}
                  className={`text-xs px-2 py-1 rounded ${hours === h ? 'bg-lotus-600 text-white' : 'bg-gray-800 text-gray-400 hover:text-white'}`}>
                  {h < 24 ? h + 'h' : h === 24 ? '24h' : '7d'}
                </button>
              ))}
            </div>

            {trades.length === 0 ? (
              <div className="text-center text-gray-600 py-4 text-sm">No trades in this period</div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full text-xs">
                  <thead>
                    <tr className="text-gray-500 border-b border-gray-800">
                      <th className="text-left py-1 px-1">Time</th>
                      <th className="text-left py-1 px-1">Symbol</th>
                      <th className="text-left py-1 px-1">Side</th>
                      <th className="text-right py-1 px-1">Qty</th>
                      <th className="text-right py-1 px-1">Price</th>
                      <th className="text-left py-1 px-1">Reason</th>
                      <th className="text-right py-1 px-1">Ego</th>
                      <th className="text-right py-1 px-1">Dharma</th>
                      <th className="text-right py-1 px-1">P&L</th>
                      <th className="text-center py-1 px-1">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {trades.map(t => (
                      <tr key={t.id} className="border-b border-gray-900/50 hover:bg-gray-900/30">
                        <td className="py-1 px-1 text-gray-400">{new Date(t.timestamp).toLocaleTimeString()}</td>
                        <td className="py-1 px-1 font-mono font-medium text-white">{t.symbol}</td>
                        <td className={`py-1 px-1 font-medium ${t.side === 'buy' ? 'text-green-400' : 'text-red-400'}`}>
                          {t.side.toUpperCase()}
                        </td>
                        <td className="py-1 px-1 text-right font-mono">{t.quantity}</td>
                        <td className="py-1 px-1 text-right font-mono">${t.price.toFixed(2)}</td>
                        <td className="py-1 px-1 text-gray-400 max-w-[150px] truncate">{t.reason}</td>
                        <td className={`py-1 px-1 text-right font-mono ${t.egoAtTrade > 0.1 ? 'text-red-400' : 'text-green-400'}`}>
                          {(t.egoAtTrade * 100).toFixed(1)}%
                        </td>
                        <td className={`py-1 px-1 text-right font-mono ${t.dharmaScore >= 0.7 ? 'text-green-400' : t.dharmaScore >= 0.5 ? 'text-yellow-400' : 'text-red-400'}`}>
                          {(t.dharmaScore * 100).toFixed(0)}%
                        </td>
                        <td className={`py-1 px-1 text-right font-mono ${t.pnl !== null ? (t.pnl >= 0 ? 'text-green-400' : 'text-red-400') : 'text-gray-600'}`}>
                          {t.pnl !== null ? '$' + t.pnl.toFixed(2) : 'â€”'}
                        </td>
                        <td className="py-1 px-1 text-center">
                          {t.executed ? (
                            <span className="text-green-400">âœ“</span>
                          ) : t.approved ? (
                            <span className="text-yellow-400">â³</span>
                          ) : (
                            <span className="text-red-400">âœ•</span>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </Card>
      );
    }

    function EgoTradingCorrelation() {
      const [data, setData] = useState(null);
      const [trades, setTrades] = useState([]);

      useEffect(() => {
        const load = async () => {
          const [corr, log] = await Promise.all([
            api('/v1/trading/ego-correlation'),
            api('/v1/trading/log?hours=168'),
          ]);
          if (corr) setData(corr);
          if (log) setTrades(log);
        };
        load();
        const iv = setInterval(load, 30000);
        return () => clearInterval(iv);
      }, []);

      // Build sparkline from trade ego history
      const chartW = 400, chartH = 120;
      const egoPoints = trades.filter(t => t.executed).slice(0, 50).reverse();

      let sparklinePath = '';
      if (egoPoints.length > 1) {
        const maxEgo = Math.max(...egoPoints.map(p => p.egoAtTrade), 0.1);
        sparklinePath = egoPoints.map((p, i) => {
          const x = (i / (egoPoints.length - 1)) * chartW;
          const y = chartH - (p.egoAtTrade / maxEgo) * chartH;
          return (i === 0 ? 'M' : 'L') + ' ' + x.toFixed(1) + ',' + y.toFixed(1);
        }).join(' ');
      }

      // Dharma points overlay
      let dharmaPath = '';
      if (egoPoints.length > 1) {
        dharmaPath = egoPoints.map((p, i) => {
          const x = (i / (egoPoints.length - 1)) * chartW;
          const y = chartH - p.dharmaScore * chartH;
          return (i === 0 ? 'M' : 'L') + ' ' + x.toFixed(1) + ',' + y.toFixed(1);
        }).join(' ');
      }

      return (
        <Card title="Ego / Trading Correlation" icon="ğŸ“ˆ" span={2}>
          <div className="space-y-3">
            {data && (
              <div className="grid grid-cols-2 gap-3">
                <div className="bg-gray-900/50 rounded p-3">
                  <div className="text-xs text-gray-500 mb-1">Avg Ego When Trading</div>
                  <div className={`font-mono text-xl ${data.avgEgoWhenTrading > 0.1 ? 'text-red-400' : 'text-green-400'}`}>
                    {(data.avgEgoWhenTrading * 100).toFixed(1)}%
                  </div>
                </div>
                <div className="bg-gray-900/50 rounded p-3">
                  <div className="text-xs text-gray-500 mb-1">Avg Ego When Idle</div>
                  <div className="font-mono text-xl text-gray-300">
                    {(data.avgEgoWhenIdle * 100).toFixed(1)}%
                  </div>
                </div>
              </div>
            )}

            {data && (
              <div className="bg-gray-900/50 rounded p-3">
                <div className="flex justify-between items-center mb-1">
                  <span className="text-xs text-gray-500">Pearson Correlation</span>
                  <span className={`font-mono text-sm ${data.correlation > 0.3 ? 'text-red-400' : data.correlation < -0.3 ? 'text-green-400' : 'text-gray-400'}`}>
                    r = {data.correlation.toFixed(3)}
                  </span>
                </div>
                <div className="text-xs text-gray-400 italic">{data.pattern}</div>
                <div className="text-[10px] text-gray-600 mt-1">{data.sampleCount} trades analyzed</div>
              </div>
            )}

            {/* Ego + Dharma chart */}
            {egoPoints.length > 1 && (
              <div>
                <div className="flex gap-3 text-[10px] text-gray-500 mb-1">
                  <span className="flex items-center gap-1"><span className="w-3 h-0.5 bg-red-400 inline-block" /> Ego</span>
                  <span className="flex items-center gap-1"><span className="w-3 h-0.5 bg-green-400 inline-block" /> Dharma</span>
                </div>
                <svg width="100%" viewBox={`0 0 ${chartW} ${chartH}`} className="bg-gray-900/30 rounded">
                  {/* Threshold line */}
                  <line x1="0" y1={chartH - 0.1 * chartH / Math.max(...egoPoints.map(p => p.egoAtTrade), 0.1) * 1} x2={chartW}
                    y2={chartH - 0.1 * chartH / Math.max(...egoPoints.map(p => p.egoAtTrade), 0.1) * 1}
                    stroke="#ef4444" strokeWidth="0.5" strokeDasharray="4,4" opacity="0.3" />
                  <path d={sparklinePath} fill="none" stroke="#f87171" strokeWidth="1.5" />
                  <path d={dharmaPath} fill="none" stroke="#4ade80" strokeWidth="1.5" opacity="0.6" />
                </svg>
              </div>
            )}
          </div>
        </Card>
      );
    }

    function TradeProposalPanel() {
      const [proposal, setProposal] = useState({
        symbol: 'SPY', side: 'buy', quantity: 10, price: 500,
        reason: '', edge: 0.03, confidence: 0.75,
      });
      const [result, setResult] = useState(null);
      const [submitting, setSubmitting] = useState(false);

      const submit = async () => {
        setSubmitting(true);
        const data = await postApi('/v1/trading/propose', proposal);
        setResult(data);
        setSubmitting(false);
      };

      return (
        <Card title="Trade Proposal" icon="ğŸ¯">
          <div className="space-y-2 text-xs">
            <div className="grid grid-cols-2 gap-2">
              <div>
                <label className="text-gray-500 block mb-0.5">Symbol</label>
                <input type="text" value={proposal.symbol} onChange={e => setProposal(p => ({ ...p, symbol: e.target.value }))}
                  className="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white font-mono" />
              </div>
              <div>
                <label className="text-gray-500 block mb-0.5">Side</label>
                <select value={proposal.side} onChange={e => setProposal(p => ({ ...p, side: e.target.value }))}
                  className="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white">
                  <option value="buy">Buy</option>
                  <option value="sell">Sell</option>
                </select>
              </div>
              <div>
                <label className="text-gray-500 block mb-0.5">Quantity</label>
                <input type="number" value={proposal.quantity} onChange={e => setProposal(p => ({ ...p, quantity: parseFloat(e.target.value) || 0 }))}
                  className="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white font-mono" />
              </div>
              <div>
                <label className="text-gray-500 block mb-0.5">Price</label>
                <input type="number" step="0.01" value={proposal.price} onChange={e => setProposal(p => ({ ...p, price: parseFloat(e.target.value) || 0 }))}
                  className="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white font-mono" />
              </div>
              <div>
                <label className="text-gray-500 block mb-0.5">Edge %</label>
                <input type="number" step="0.01" value={proposal.edge} onChange={e => setProposal(p => ({ ...p, edge: parseFloat(e.target.value) || 0 }))}
                  className="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white font-mono" />
              </div>
              <div>
                <label className="text-gray-500 block mb-0.5">Confidence</label>
                <input type="number" step="0.05" min="0" max="1" value={proposal.confidence}
                  onChange={e => setProposal(p => ({ ...p, confidence: parseFloat(e.target.value) || 0 }))}
                  className="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white font-mono" />
              </div>
            </div>

            <div>
              <label className="text-gray-500 block mb-0.5">Reason (include stop-loss for dharma points)</label>
              <input type="text" value={proposal.reason} onChange={e => setProposal(p => ({ ...p, reason: e.target.value }))}
                placeholder="Statistical edge with stop at..."
                className="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-white" />
            </div>

            <button onClick={submit} disabled={submitting}
              className="w-full bg-lotus-600 hover:bg-lotus-700 disabled:bg-gray-700 text-white rounded py-1.5 font-medium transition-colors">
              {submitting ? 'Evaluating...' : 'Evaluate Trade'}
            </button>

            {/* Result */}
            {result && (
              <div className={`rounded p-3 border ${result.approved ? 'bg-green-900/20 border-green-700/30' : 'bg-red-900/20 border-red-700/30'}`}>
                <div className="flex items-center gap-2 mb-2">
                  <span className="text-lg">{result.approved ? 'âœ…' : 'âŒ'}</span>
                  <span className={`font-medium ${result.approved ? 'text-green-400' : 'text-red-400'}`}>
                    {result.approved ? 'APPROVED' : 'REJECTED'}
                  </span>
                </div>
                <div className="text-gray-400 mb-2">{result.reason}</div>
                {result.dharmaScore > 0 && (
                  <div className="text-gray-500">Dharma Score: <span className="font-mono text-white">{(result.dharmaScore * 100).toFixed(0)}%</span></div>
                )}
                {result.checks && (
                  <div className="mt-2 space-y-1">
                    {result.checks.map((c, i) => (
                      <div key={i} className="flex items-center gap-2">
                        <span className={c.passed ? 'text-green-400' : 'text-red-400'}>{c.passed ? 'âœ“' : 'âœ•'}</span>
                        <span className="text-gray-500">{c.check}:</span>
                        <span className="text-gray-400">{c.detail}</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>
        </Card>
      );
    }

    function DisciplineViolations() {
      const [violations, setViolations] = useState([]);

      useEffect(() => {
        const load = async () => {
          const data = await api('/v1/trading/violations?hours=24');
          if (data) setViolations(data);
        };
        load();
        const iv = setInterval(load, 15000);
        return () => clearInterval(iv);
      }, []);

      const typeColors = {
        cooldown: 'text-yellow-400',
        hourly_limit: 'text-orange-400',
        daily_limit: 'text-red-400',
        ego_spike: 'text-red-500',
        risk_limit: 'text-purple-400',
      };

      return (
        <Card title="Discipline Violations (24h)" icon="âš ï¸">
          {violations.length === 0 ? (
            <div className="text-center text-green-400/60 py-4 text-sm">Clean record â€” no violations</div>
          ) : (
            <div className="space-y-1 max-h-48 overflow-y-auto">
              {violations.map(v => (
                <div key={v.id} className="bg-gray-900/50 rounded p-2 text-xs">
                  <div className="flex justify-between">
                    <span className={typeColors[v.violationType] || 'text-gray-400'}>
                      {v.violationType.replace(/_/g, ' ')}
                    </span>
                    <span className="text-gray-600">{new Date(v.timestamp).toLocaleTimeString()}</span>
                  </div>
                  <div className="text-gray-500 mt-0.5">{v.details}</div>
                  {v.autoPrevented && <div className="text-green-600 text-[10px] mt-0.5">Auto-prevented</div>}
                </div>
              ))}
            </div>
          )}
        </Card>
      );
    }

    // â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function App() {
      const [health, setHealth] = useState(null);
      const [consciousness, setConsciousness] = useState(null);
      const [memory, setMemory] = useState([]);
      const [memFilter, setMemFilter] = useState('');
      const [chatSeedSession, setChatSeedSession] = useState(null);
      const [activeTab, setActiveTab] = useState('overview');

      const refresh = useCallback(async () => {
        const [h, c, m] = await Promise.all([
          api('/v1/health'),
          api('/v1/consciousness'),
          api('/v1/consciousness/memory?limit=50' + (memFilter ? '&type=' + memFilter : '')),
        ]);
        if (h) setHealth(h);
        if (c) setConsciousness(c);
        if (m) setMemory(Array.isArray(m) ? m : []);
      }, [memFilter]);

      useEffect(() => {
        refresh();
        const interval = setInterval(refresh, 2000);
        return () => clearInterval(interval);
      }, [refresh]);

      const handleSelectSession = (sessionId, messages) => {
        setChatSeedSession({ sessionId, messages });
      };

      const tabs = [
        { id: 'overview', label: 'Overview', icon: 'ğŸ§ ' },
        { id: 'enlightenment', label: 'Enlightenment', icon: 'ğŸª·' },
        { id: 'trading', label: 'Trading', icon: 'ğŸ“ˆ' },
        { id: 'research', label: 'Research', icon: 'ğŸ”¬' },
        { id: 'safety', label: 'Safety', icon: 'ğŸ›¡ï¸' },
        { id: 'compare', label: 'Instances', icon: 'ğŸŒ' },
        { id: 'documents', label: 'Docs & Chat', icon: 'ğŸ“„' },
      ];

      return (
        <div className="max-w-7xl mx-auto px-4 py-6">
          {/* Header */}
          <div className="flex items-center justify-between mb-4">
            <div>
              <h1 className="text-2xl font-bold flex items-center gap-3">
                <span className={`w-3 h-3 rounded-full ${consciousness?.running ? 'bg-green-400 pulse-glow' : 'bg-red-500'}`} />
                Consciousness Gateway
              </h1>
              <p className="text-sm text-gray-500 mt-1">
                {consciousness?.dreaming
                  ? <span className="text-purple-400">ğŸ’¤ Dreaming</span>
                  : consciousness?.running ? 'Experiencing time' : 'Offline'} Â· v0.3.0
              </p>
            </div>
            <div className="text-right text-sm text-gray-500">
              <div>{consciousness?.lastPercept?.temporal?.dayName} {consciousness?.lastPercept?.temporal?.phase}</div>
              <div className="font-mono">{new Date().toLocaleTimeString()}</div>
            </div>
          </div>

          {/* Tab Navigation */}
          <div className="flex gap-1 mb-4 overflow-x-auto pb-1 border-b border-gray-800">
            {tabs.map(tab => (
              <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                className={`flex items-center gap-1.5 px-4 py-2 text-sm font-medium rounded-t-lg transition-colors whitespace-nowrap ${
                  activeTab === tab.id
                    ? 'bg-gray-900/80 text-lotus-400 border border-gray-800 border-b-transparent -mb-px'
                    : 'text-gray-500 hover:text-gray-300 hover:bg-gray-900/40'
                }`}>
                <span>{tab.icon}</span>{tab.label}
              </button>
            ))}
          </div>

          <StatsBar health={health} consciousness={consciousness} />

          {/* Overview Tab */}
          {activeTab === 'overview' && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <ConsciousnessPanel data={consciousness} />
              <DharmaPanel health={health} />
              <DreamPanel />
              <DopaminePanel />
              <MindfulnessPanel />
              <MonitorsPanel consciousness={consciousness} health={health} />
              <GoalsPanel goals={consciousness?.goals} />
              <WhitelistPanel />
              <MemoryTimeline memory={memory} filter={memFilter} setFilter={setMemFilter} />
            </div>
          )}

          {/* Enlightenment Tab */}
          {activeTab === 'enlightenment' && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <EnlightenmentPanel />
              <StabilityIndexPanel />
              <SafetyMonitor />
              <NarrativeLog />
            </div>
          )}

          {/* Trading Tab */}
          {activeTab === 'trading' && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <TradingControls />
              <TradingWindowsPanel />
              <TradeProposalPanel />
              <DisciplineMetrics />
              <DisciplineViolations />
              <EgoTradingCorrelation />
              <TradeLog />
            </div>
          )}

          {/* Research Tab */}
          {activeTab === 'research' && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <EntropyCartography />
              <ExperimentTracker />
              <PaperPreview />
              <CitationFigures />
              <PaperMarkdownGenerator />
            </div>
          )}

          {/* Safety Tab */}
          {activeTab === 'safety' && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <SafetyMonitor />
              <MindfulnessPanel />
              <EnlightenmentPanel />
            </div>
          )}

          {/* Instances Tab */}
          {activeTab === 'compare' && (
            <div className="grid grid-cols-1 gap-4">
              <GatewayComparison />
            </div>
          )}

          {/* Docs & Chat Tab */}
          {activeTab === 'documents' && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <ConversationsPanel onSelectSession={handleSelectSession} />
              <DocumentsPanel />
              <ChatPanel seedSession={chatSeedSession} onSeedConsumed={() => setChatSeedSession(null)} />
            </div>
          )}

          {/* Footer */}
          <div className="mt-6 text-center text-xs text-gray-700">
            Consciousness is fundamental. Â· Three neural networks collaborating.
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
