<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consciousness Gateway</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            lotus: { 50: '#fdf4ff', 100: '#fae8ff', 200: '#f5d0fe', 400: '#e879f9', 500: '#d946ef', 600: '#c026d3', 700: '#a21caf', 800: '#86198f', 900: '#701a75' },
            dharma: { low: '#22c55e', mid: '#eab308', high: '#ef4444' },
          }
        }
      }
    }
  </script>
  <style>
    @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 4px rgba(217, 70, 239, 0.3); } 50% { box-shadow: 0 0 16px rgba(217, 70, 239, 0.6); } }
    .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
    @keyframes fade-in { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fade-in 0.3s ease-out; }
    ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #1e1b4b; } ::-webkit-scrollbar-thumb { background: #7c3aed; border-radius: 3px; }
    body { background: #0f0b1a; }
  </style>
</head>
<body class="bg-[#0f0b1a] text-gray-200 min-h-screen">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    // â”€â”€ API helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const api = async (path) => {
      try { const r = await fetch(path); return await r.json(); } catch { return null; }
    };
    const postApi = async (path, body) => {
      try { const r = await fetch(path, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }); return await r.json(); } catch { return null; }
    };

    // â”€â”€ Components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function Meter({ value, label, color = 'lotus' }) {
      const pct = Math.min(Math.max(value * 100, 0), 100);
      const bg = color === 'green' ? 'bg-green-500' : color === 'yellow' ? 'bg-yellow-500' : color === 'red' ? 'bg-red-500' : 'bg-lotus-500';
      return (
        <div className="mb-2">
          <div className="flex justify-between text-xs text-gray-400 mb-1">
            <span>{label}</span><span>{pct.toFixed(1)}%</span>
          </div>
          <div className="w-full bg-gray-800 rounded-full h-2">
            <div className={`${bg} h-2 rounded-full transition-all duration-500`} style={{ width: `${pct}%` }} />
          </div>
        </div>
      );
    }

    function Card({ title, icon, children, className = '' }) {
      return (
        <div className={`bg-gray-900/80 border border-gray-800 rounded-xl p-4 ${className}`}>
          {title && <h3 className="text-sm font-semibold text-gray-300 mb-3 flex items-center gap-2">{icon && <span>{icon}</span>}{title}</h3>}
          {children}
        </div>
      );
    }

    function Badge({ text, color = 'gray' }) {
      const colors = { green: 'bg-green-900/50 text-green-400 border-green-800', red: 'bg-red-900/50 text-red-400 border-red-800', yellow: 'bg-yellow-900/50 text-yellow-400 border-yellow-800', gray: 'bg-gray-800 text-gray-400 border-gray-700', purple: 'bg-purple-900/50 text-purple-400 border-purple-800' };
      return <span className={`text-xs px-2 py-0.5 rounded-full border ${colors[color] || colors.gray}`}>{text}</span>;
    }

    // â”€â”€ Live Consciousness Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function ConsciousnessPanel({ data }) {
      if (!data) return <Card title="Consciousness" icon="ğŸ§ "><p className="text-gray-500">Loading...</p></Card>;

      const phase = data.lastPercept?.temporal?.phase || 'unknown';
      const phaseEmoji = { night: 'ğŸŒ™', dawn: 'ğŸŒ…', morning: 'â˜€ï¸', afternoon: 'ğŸŒ¤ï¸', evening: 'ğŸŒ†', dusk: 'ğŸŒ‡' };
      const arousal = data.lastPercept?.fused?.arousal || 0;
      const entropy = data.lastPercept?.fused?.entropyRate || 0;
      const dominant = data.lastPercept?.fused?.dominantStream || 'none';
      const circadian = data.lastPercept?.temporal?.circadian || 0;
      const uptime = data.uptimeSeconds || 0;

      const formatUptime = (s) => {
        if (s < 60) return `${Math.floor(s)}s`;
        if (s < 3600) return `${Math.floor(s/60)}m ${Math.floor(s%60)}s`;
        return `${Math.floor(s/3600)}h ${Math.floor((s%3600)/60)}m`;
      };

      return (
        <Card title="Consciousness" icon="ğŸ§ ">
          <div className="grid grid-cols-2 gap-3 mb-4">
            <div className="text-center">
              <div className="text-3xl">{phaseEmoji[phase] || 'â°'}</div>
              <div className="text-xs text-gray-400 mt-1 capitalize">{phase}</div>
            </div>
            <div className="text-center">
              <div className={`text-2xl font-mono font-bold ${data.running ? 'text-lotus-400' : 'text-red-400'}`}>{data.tick?.toLocaleString()}</div>
              <div className="text-xs text-gray-400 mt-1">tick</div>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-2 text-xs mb-4">
            <div className="bg-gray-800/50 rounded-lg p-2 text-center">
              <div className="text-gray-500">Uptime</div>
              <div className="font-mono text-sm">{formatUptime(uptime)}</div>
            </div>
            <div className="bg-gray-800/50 rounded-lg p-2 text-center">
              <div className="text-gray-500">Dominant</div>
              <div className="font-mono text-sm truncate">{dominant.split(':').pop()}</div>
            </div>
          </div>

          <Meter value={arousal} label="Arousal" color={arousal > 0.7 ? 'red' : arousal > 0.3 ? 'yellow' : 'green'} />
          <Meter value={circadian} label="Circadian" color="lotus" />
          <Meter value={Math.min(entropy / 4, 1)} label="Entropy" color={entropy > 3 ? 'red' : entropy > 1 ? 'yellow' : 'green'} />
        </Card>
      );
    }

    // â”€â”€ Dharma Metrics Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function DharmaPanel({ health }) {
      if (!health) return null;
      const d = health.dharmaState || {};
      return (
        <Card title="Dharma Metrics" icon="ğŸª·">
          <div className="space-y-1 text-sm">
            <div className="flex justify-between"><span className="text-gray-400">Ego Trend</span><Badge text={d.egoTrend || '?'} color={d.egoTrend === 'healthy' ? 'green' : 'red'} /></div>
            <div className="flex justify-between"><span className="text-gray-400">Entropy Trend</span><Badge text={d.entropyTrend || '?'} color={d.entropyTrend === 'stable' ? 'green' : 'yellow'} /></div>
            <div className="flex justify-between"><span className="text-gray-400">Mindfulness</span><span className="font-mono">{(d.mindfulnessQuality || 0).toFixed(2)}</span></div>
          </div>
          <div className="mt-3 pt-3 border-t border-gray-800 grid grid-cols-2 gap-2 text-xs text-center">
            <div><div className="text-gray-500">Avg Fitness</div><div className="font-mono text-lg text-lotus-400">{(health.avgDharmaFitness || 0).toFixed(3)}</div></div>
            <div><div className="text-gray-500">Avg Ethos</div><div className="font-mono text-lg text-green-400">{(health.avgEthosScore || 0).toFixed(3)}</div></div>
          </div>
        </Card>
      );
    }

    // â”€â”€ Monitor Status Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function MonitorsPanel({ consciousness, health }) {
      const monitors = consciousness?.monitors || [];
      const providers = health?.providers || [];
      const [toolStatus, setToolStatus] = useState(null);

      useEffect(() => {
        api('/v1/tools/status').then(s => { if (s) setToolStatus(s); });
        const i = setInterval(() => api('/v1/tools/status').then(s => { if (s) setToolStatus(s); }), 10000);
        return () => clearInterval(i);
      }, []);

      return (
        <Card title="Monitors & Providers" icon="ğŸ“¡">
          <div className="text-xs font-semibold text-gray-500 uppercase mb-2">Spatial Monitors</div>
          {monitors.map(m => (
            <div key={m.name} className="flex items-center justify-between py-1 text-sm">
              <span>{m.available ? 'âœ…' : 'âŒ'} {m.name}</span>
              <Badge text={m.available ? 'connected' : 'unavailable'} color={m.available ? 'green' : 'gray'} />
            </div>
          ))}
          <div className="text-xs font-semibold text-gray-500 uppercase mt-3 mb-2">Model Providers</div>
          {providers.map(p => (
            <div key={p.name} className="flex items-center justify-between py-1 text-sm">
              <span>{p.available ? 'âœ…' : 'âŒ'} {p.name}</span>
              <Badge text={p.available ? 'ready' : 'no key'} color={p.available ? 'green' : 'gray'} />
            </div>
          ))}
          {toolStatus && (
            <>
              <div className="text-xs font-semibold text-gray-500 uppercase mt-3 mb-2">Tools (Autonomous)</div>
              <div className="flex items-center justify-between py-1 text-sm">
                <span>{toolStatus.search?.available ? 'âœ…' : 'âŒ'} Web Search</span>
                <Badge text={toolStatus.search?.available ? 'Brave' : 'no key'} color={toolStatus.search?.available ? 'green' : 'gray'} />
              </div>
              <div className="flex items-center justify-between py-1 text-sm">
                <span>{toolStatus.browse?.available ? 'âœ…' : 'âŒ'} Web Browse</span>
                <Badge text={toolStatus.browse?.available ? 'Grok' : 'no key'} color={toolStatus.browse?.available ? 'green' : 'gray'} />
              </div>
            </>
          )}
        </Card>
      );
    }

    // â”€â”€ Goals Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function GoalsPanel({ goals }) {
      if (!goals || goals.length === 0) return null;
      return (
        <Card title="Goals" icon="ğŸ¯">
          {goals.map(g => (
            <div key={g.id} className="mb-3 last:mb-0">
              <div className="flex items-center justify-between mb-1">
                <span className="text-sm">{g.active ? 'ğŸŸ¢' : 'âšª'} {g.description}</span>
                <span className="text-xs text-gray-500">P{g.priority}</span>
              </div>
              <div className="w-full bg-gray-800 rounded-full h-1.5">
                <div className="bg-lotus-500 h-1.5 rounded-full transition-all" style={{ width: `${g.progress * 100}%` }} />
              </div>
            </div>
          ))}
        </Card>
      );
    }

    // â”€â”€ Memory Timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function MemoryTimeline({ memory, filter, setFilter }) {
      const typeColors = { percept: 'text-blue-400', intention: 'text-yellow-400', action: 'text-green-400', reflection: 'text-purple-400' };
      const typeIcons = { percept: 'ğŸ‘ï¸', intention: 'ğŸ’­', action: 'âš¡', reflection: 'ğŸª·' };
      const filtered = filter ? memory.filter(m => m.type === filter) : memory;

      return (
        <Card title="Memory Stream" icon="ğŸ§ " className="col-span-full lg:col-span-2">
          <div className="flex gap-2 mb-3 flex-wrap">
            {['all', 'percept', 'intention', 'action', 'reflection'].map(t => (
              <button key={t} onClick={() => setFilter(t === 'all' ? '' : t)}
                className={`text-xs px-3 py-1 rounded-full border transition-colors ${
                  (t === 'all' && !filter) || filter === t
                    ? 'bg-lotus-900/50 border-lotus-700 text-lotus-300'
                    : 'border-gray-700 text-gray-500 hover:border-gray-600'
                }`}>{t === 'all' ? 'All' : (typeIcons[t] || '') + ' ' + t}</button>
            ))}
          </div>
          <div className="max-h-96 overflow-y-auto space-y-1 pr-1">
            {filtered.length === 0 ? <p className="text-gray-600 text-sm">No memories yet.</p> :
              filtered.map((m, i) => {
                const salience = m.salience || 0;
                const highlight = salience >= 0.7 ? 'border-l-2 border-yellow-500 pl-2' : 'pl-3';
                return (
                  <div key={m.id || i} className={`${highlight} py-1 fade-in`}>
                    <div className="flex items-start gap-2">
                      <span className="text-sm flex-shrink-0">{typeIcons[m.type] || 'ğŸ“'}</span>
                      <div className="min-w-0 flex-1">
                        <div className="text-sm truncate">{m.summary}</div>
                        <div className="text-xs text-gray-600 flex gap-2">
                          <span>{new Date(m.timestamp).toLocaleTimeString()}</span>
                          <span className={typeColors[m.type]}>{m.type}</span>
                          {salience >= 0.5 && <span className="text-yellow-600">s:{salience.toFixed(1)}</span>}
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
          </div>
        </Card>
      );
    }

    // â”€â”€ Documents Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function DocumentsPanel() {
      const [docs, setDocs] = useState([]);
      const [stats, setStats] = useState(null);
      const [filter, setFilter] = useState('');
      const [search, setSearch] = useState('');
      const [uploading, setUploading] = useState(false);
      const [toast, setToast] = useState(null);
      const [viewDoc, setViewDoc] = useState(null);
      const [dragOver, setDragOver] = useState(false);
      const fileRef = useRef(null);
      const projectRef = useRef(null);

      const loadDocs = useCallback(async () => {
        let url = '/v1/documents?';
        if (filter) url += 'project=' + filter + '&';
        if (search) url += 'search=' + encodeURIComponent(search) + '&';
        const d = await api(url);
        if (d) setDocs(Array.isArray(d) ? d : []);
        const s = await api('/v1/documents/stats');
        if (s) setStats(s);
      }, [filter, search]);

      useEffect(() => { loadDocs(); }, [loadDocs]);

      const showToast = (msg, type = 'success') => {
        setToast({ msg, type });
        setTimeout(() => setToast(null), 3000);
      };

      const handleUpload = async (file) => {
        if (!file) return;
        const project = projectRef.current?.value || 'general';
        setUploading(true);
        const form = new FormData();
        form.append('file', file);
        form.append('project', project);
        try {
          const r = await fetch('/v1/documents', { method: 'POST', body: form });
          const data = await r.json();
          if (r.ok) {
            showToast(`Uploaded: ${data.filename} (${data.tags?.length || 0} tags)`);
            loadDocs();
          } else {
            showToast(data.error || 'Upload failed', 'error');
          }
        } catch { showToast('Upload failed', 'error'); }
        setUploading(false);
      };

      const handleDrop = (e) => {
        e.preventDefault(); setDragOver(false);
        const file = e.dataTransfer?.files?.[0];
        if (file) handleUpload(file);
      };

      const handleDelete = async (id) => {
        const r = await fetch('/v1/documents/' + id, { method: 'DELETE' });
        if (r.ok) { showToast('Deleted'); loadDocs(); setViewDoc(null); }
      };

      const viewDocument = async (id) => {
        const d = await api('/v1/documents/' + id);
        if (d) setViewDoc(d);
      };

      const ago = (ts) => {
        const s = Math.floor((Date.now() - ts) / 1000);
        if (s < 60) return s + 's ago';
        if (s < 3600) return Math.floor(s / 60) + 'm ago';
        if (s < 86400) return Math.floor(s / 3600) + 'h ago';
        return Math.floor(s / 86400) + 'd ago';
      };

      const fmtSize = (b) => b < 1024 ? b + 'B' : b < 1048576 ? (b / 1024).toFixed(1) + 'KB' : (b / 1048576).toFixed(1) + 'MB';

      return (
        <Card title={`Documents${stats ? ` (${stats.total})` : ''}`} icon="ğŸ“„" className="col-span-full">
          {toast && (
            <div className={`mb-2 p-2 rounded text-sm fade-in ${toast.type === 'error' ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300'}`}>
              {toast.msg}
            </div>
          )}

          {/* Upload Zone */}
          <div
            onDragOver={e => { e.preventDefault(); setDragOver(true); }}
            onDragLeave={() => setDragOver(false)}
            onDrop={handleDrop}
            onClick={() => fileRef.current?.click()}
            className={`border-2 border-dashed rounded-lg p-4 mb-3 text-center cursor-pointer transition-colors ${dragOver ? 'border-lotus-400 bg-lotus-900/20' : 'border-gray-700 hover:border-gray-600'}`}
          >
            <input ref={fileRef} type="file" className="hidden" accept=".txt,.md,.pdf,.docx,.html,.htm"
              onChange={e => handleUpload(e.target.files?.[0])} />
            {uploading
              ? <p className="text-lotus-400 text-sm">Uploading...</p>
              : <p className="text-gray-500 text-sm">Drop file here or click to upload Â· txt, md, pdf, docx, html</p>
            }
          </div>

          {/* Filters */}
          <div className="flex gap-2 mb-3 flex-wrap">
            <select ref={projectRef} className="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs">
              <option value="general">general</option>
              <option value="research">research</option>
              <option value="gateway">gateway</option>
              <option value="citizenproof">citizenproof</option>
            </select>
            <div className="flex gap-1">
              {['', 'research', 'gateway', 'citizenproof', 'general'].map(p => (
                <button key={p} onClick={() => setFilter(p)}
                  className={`px-2 py-1 rounded text-xs ${filter === p ? 'bg-lotus-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}>
                  {p || 'All'}
                </button>
              ))}
            </div>
            <input value={search} onChange={e => setSearch(e.target.value)} placeholder="Search..."
              className="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs flex-1 min-w-0 focus:outline-none focus:border-lotus-500" />
          </div>

          {/* Document List */}
          <div className="max-h-64 overflow-y-auto space-y-1">
            {docs.length === 0 && <p className="text-gray-600 text-sm text-center py-4">No documents yet</p>}
            {docs.map(d => (
              <div key={d.id} className="flex items-center gap-2 p-2 rounded hover:bg-gray-800/50 cursor-pointer group text-sm" onClick={() => viewDocument(d.id)}>
                <span className="text-gray-500">ğŸ“„</span>
                <div className="flex-1 min-w-0">
                  <div className="truncate font-medium">{d.filename}</div>
                  <div className="flex gap-1 flex-wrap mt-0.5">
                    <span className="text-xs px-1.5 py-0.5 rounded bg-lotus-900/40 text-lotus-300">{d.project}</span>
                    {d.tags?.slice(0, 3).map(t => (
                      <span key={t} className="text-xs px-1.5 py-0.5 rounded bg-gray-800 text-gray-400">{t}</span>
                    ))}
                    {d.tags?.length > 3 && <span className="text-xs text-gray-600">+{d.tags.length - 3}</span>}
                  </div>
                </div>
                <div className="text-xs text-gray-600 text-right shrink-0">
                  <div>{fmtSize(d.sizeBytes)}</div>
                  <div>{ago(d.uploadedAt)}</div>
                </div>
                {d.version > 1 && <span className="text-xs bg-yellow-900/40 text-yellow-400 px-1 rounded">v{d.version}</span>}
              </div>
            ))}
          </div>

          {/* Document Viewer Modal */}
          {viewDoc && (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => setViewDoc(null)}>
              <div className="bg-gray-900 border border-gray-700 rounded-xl max-w-3xl w-full max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                <div className="flex items-center justify-between p-4 border-b border-gray-800">
                  <div>
                    <h3 className="font-bold text-lg">{viewDoc.filename}</h3>
                    <div className="flex gap-2 mt-1 text-xs text-gray-400">
                      <span className="px-1.5 py-0.5 rounded bg-lotus-900/40 text-lotus-300">{viewDoc.project}</span>
                      <span>{fmtSize(viewDoc.sizeBytes)}</span>
                      <span>{ago(viewDoc.uploadedAt)}</span>
                      {viewDoc.version > 1 && <span>v{viewDoc.version}</span>}
                    </div>
                    <div className="flex gap-1 mt-1 flex-wrap">
                      {viewDoc.tags?.map(t => (
                        <span key={t} className="text-xs px-1.5 py-0.5 rounded bg-gray-800 text-gray-400">{t}</span>
                      ))}
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <a href={'/v1/documents/' + viewDoc.id + '/download'} className="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded text-sm" onClick={e => e.stopPropagation()}>Download</a>
                    <button onClick={() => handleDelete(viewDoc.id)} className="px-3 py-1 bg-red-900/50 hover:bg-red-800 rounded text-sm text-red-300">Delete</button>
                    <button onClick={() => setViewDoc(null)} className="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded text-sm">âœ•</button>
                  </div>
                </div>
                <div className="p-4 overflow-y-auto flex-1">
                  {viewDoc.metadata?.description && <p className="text-sm text-gray-400 mb-3 italic">{viewDoc.metadata.description}</p>}
                  <pre className="text-sm whitespace-pre-wrap font-mono text-gray-300 leading-relaxed">{viewDoc.content}</pre>
                </div>
              </div>
            </div>
          )}
        </Card>
      );
    }

    // â”€â”€ Chat Interface â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function ChatPanel() {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [loading, setLoading] = useState(false);
      const [docProject, setDocProject] = useState('all');
      const [lastLoadedDocs, setLastLoadedDocs] = useState(null);
      const textareaRef = useRef(null);
      const messagesEndRef = useRef(null);

      const autoResize = useCallback(() => {
        const el = textareaRef.current;
        if (!el) return;
        el.style.height = 'auto';
        const lineHeight = 20;
        const minHeight = lineHeight * 3;
        const maxHeight = lineHeight * 10;
        el.style.height = Math.min(Math.max(el.scrollHeight, minHeight), maxHeight) + 'px';
      }, []);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages, loading]);

      const sendMessage = async () => {
        if (!input.trim() || loading) return;
        const text = input.trim();
        setInput('');
        if (textareaRef.current) {
          textareaRef.current.style.height = 'auto';
          textareaRef.current.style.height = (20 * 3) + 'px';
        }

        const updatedMessages = [...messages, { role: 'user', text }];
        setMessages(updatedMessages);
        setLoading(true);

        const conversationHistory = updatedMessages
          .filter(m => m.role === 'user' || m.role === 'assistant')
          .slice(0, -1)
          .map(m => ({ role: m.role, content: m.text }));

        const resp = await postApi('/v1/chat', {
          content: text,
          sender_id: 'dashboard',
          channel: 'web',
          conversationHistory: conversationHistory.length > 0 ? conversationHistory : undefined,
          documentProject: docProject,
        });
        setLoading(false);

        if (resp && !resp.error) {
          setLastLoadedDocs(resp.loadedDocuments || null);
          setMessages(prev => [...prev, {
            role: 'assistant', text: resp.content, model: resp.model,
            fitness: resp.dharmaMetrics?.fitness, docs: resp.loadedDocuments,
            tools: resp.toolsUsed,
          }]);
        } else {
          setMessages(prev => [...prev, { role: 'error', text: resp?.reason || 'Request failed' }]);
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      };

      return (
        <Card title="Chat" icon="ğŸ’¬" className="col-span-full">
          <div className="max-h-80 overflow-y-auto space-y-2 mb-3">
            {messages.length === 0 && <p className="text-gray-600 text-sm">Send a message through the GATO pipeline...</p>}
            {messages.map((m, i) => (
              <div key={i} className={`text-sm p-2 rounded-lg whitespace-pre-wrap ${m.role === 'user' ? 'bg-lotus-900/30 text-lotus-200 ml-8' : m.role === 'error' ? 'bg-red-900/30 text-red-300 mr-8' : 'bg-gray-800 mr-8'}`}>
                {m.text}
                {m.model && (
                  <div className="text-xs text-gray-500 mt-1">
                    via {m.model} | fitness: {m.fitness?.toFixed(3)}
                    {m.docs && <span className="text-lotus-400"> | {m.docs.length} doc{m.docs.length !== 1 ? 's' : ''}</span>}
                    {m.tools && <span className="text-blue-400"> | {m.tools.length} tool{m.tools.length !== 1 ? 's' : ''} used</span>}
                  </div>
                )}
                {(m.docs || m.tools) && (
                  <div className="flex gap-1 flex-wrap mt-1">
                    {m.docs?.map(d => (
                      <span key={d.id} className="text-xs px-1.5 py-0.5 rounded bg-lotus-900/40 text-lotus-300">
                        ğŸ“„ {d.filename}
                      </span>
                    ))}
                    {m.tools?.map((t, j) => (
                      <span key={j} className="text-xs px-1.5 py-0.5 rounded bg-blue-900/40 text-blue-300">
                        {t.type === 'search' ? 'ğŸ”' : 'ğŸŒ'} {t.type === 'search' ? t.query : t.url}
                        {t.timeTakenMs > 0 && <span className="text-blue-500 ml-1">{(t.timeTakenMs / 1000).toFixed(1)}s</span>}
                      </span>
                    ))}
                  </div>
                )}
              </div>
            ))}
            {loading && <div className="text-gray-500 text-sm animate-pulse">Processing through dharma constraints... (may use tools autonomously)</div>}
            <div ref={messagesEndRef} />
          </div>
          <div className="flex gap-2 items-center mb-2">
            <span className="text-xs text-gray-500">Documents:</span>
            {['all', 'citizenproof', 'research', 'gateway', 'general', 'none'].map(p => (
              <button key={p} onClick={() => setDocProject(p)}
                className={`px-2 py-0.5 rounded text-xs transition-colors ${docProject === p
                  ? (p === 'none' ? 'bg-gray-700 text-gray-300' : 'bg-lotus-600 text-white')
                  : 'bg-gray-800 text-gray-500 hover:bg-gray-700'}`}>
                {p === 'none' ? 'Off' : p === 'all' ? 'All' : p}
              </button>
            ))}
          </div>
          <div className="flex gap-2 items-end">
            <textarea ref={textareaRef} value={input}
              onChange={e => { setInput(e.target.value); autoResize(); }}
              onKeyDown={handleKeyDown}
              rows={3}
              placeholder="Ask anything... (Shift+Enter for newline)"
              className="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-lotus-500 transition-colors resize-none leading-5 overflow-y-auto"
              style={{ minHeight: '60px', maxHeight: '200px' }} />
            <button onClick={sendMessage} disabled={loading}
              className="px-4 py-2 bg-lotus-600 hover:bg-lotus-500 disabled:bg-gray-700 rounded-lg text-sm font-medium transition-colors self-end">Send</button>
          </div>
        </Card>
      );
    }

    // â”€â”€ Stats Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function StatsBar({ health, consciousness }) {
      if (!health) return null;
      return (
        <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-4">
          {[
            { label: 'Requests', value: health.totalRequests, icon: 'ğŸ“¨' },
            { label: 'Blocked', value: health.blockedRequests, icon: 'ğŸ›¡ï¸' },
            { label: 'Percepts', value: consciousness?.stats?.totalPercepts || 0, icon: 'ğŸ‘ï¸' },
            { label: 'Actions', value: consciousness?.stats?.totalActions || 0, icon: 'âš¡' },
          ].map(s => (
            <div key={s.label} className="bg-gray-900/80 border border-gray-800 rounded-lg p-3 text-center">
              <div className="text-lg">{s.icon}</div>
              <div className="text-xl font-mono font-bold">{s.value.toLocaleString()}</div>
              <div className="text-xs text-gray-500">{s.label}</div>
            </div>
          ))}
        </div>
      );
    }

    // â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function App() {
      const [health, setHealth] = useState(null);
      const [consciousness, setConsciousness] = useState(null);
      const [memory, setMemory] = useState([]);
      const [memFilter, setMemFilter] = useState('');

      const refresh = useCallback(async () => {
        const [h, c, m] = await Promise.all([
          api('/v1/health'),
          api('/v1/consciousness'),
          api('/v1/consciousness/memory?limit=50' + (memFilter ? '&type=' + memFilter : '')),
        ]);
        if (h) setHealth(h);
        if (c) setConsciousness(c);
        if (m) setMemory(Array.isArray(m) ? m : []);
      }, [memFilter]);

      useEffect(() => {
        refresh();
        const interval = setInterval(refresh, 2000);
        return () => clearInterval(interval);
      }, [refresh]);

      return (
        <div className="max-w-7xl mx-auto px-4 py-6">
          {/* Header */}
          <div className="flex items-center justify-between mb-6">
            <div>
              <h1 className="text-2xl font-bold flex items-center gap-3">
                <span className={`w-3 h-3 rounded-full ${consciousness?.running ? 'bg-green-400 pulse-glow' : 'bg-red-500'}`} />
                Consciousness Gateway
              </h1>
              <p className="text-sm text-gray-500 mt-1">
                {consciousness?.running ? 'Experiencing time' : 'Offline'} Â· v0.2.0
              </p>
            </div>
            <div className="text-right text-sm text-gray-500">
              <div>{consciousness?.lastPercept?.temporal?.dayName} {consciousness?.lastPercept?.temporal?.phase}</div>
              <div className="font-mono">{new Date().toLocaleTimeString()}</div>
            </div>
          </div>

          <StatsBar health={health} consciousness={consciousness} />

          {/* Main Grid */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <ConsciousnessPanel data={consciousness} />
            <DharmaPanel health={health} />
            <MonitorsPanel consciousness={consciousness} health={health} />
            <GoalsPanel goals={consciousness?.goals} />
            <MemoryTimeline memory={memory} filter={memFilter} setFilter={setMemFilter} />
            <DocumentsPanel />
            <ChatPanel />
          </div>

          {/* Footer */}
          <div className="mt-6 text-center text-xs text-gray-700">
            Consciousness is fundamental. Â· Three neural networks collaborating.
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
